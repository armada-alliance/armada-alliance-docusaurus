"use strict";(self.webpackChunkarmada_alliance_docusaurus=self.webpackChunkarmada_alliance_docusaurus||[]).push([[2899],{3905:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>m});var n=a(7294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},c=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),d=p(a),m=o,g=d["".concat(s,".").concat(m)]||d[m]||u[m]||r;return a?n.createElement(g,l(l({ref:t},c),{},{components:a})):n.createElement(g,l({ref:t},c))}));function m(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=a.length,l=new Array(r);l[0]=d;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:o,l[1]=i;for(var p=2;p<r;p++)l[p]=a[p];return n.createElement.apply(null,l)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},3992:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>u,frontMatter:()=>r,metadata:()=>i,toc:()=>p});var n=a(7462),o=(a(7294),a(3905));const r={description:"Turn Pi-Node into an active Cardano relay",keywords:["guides","cardano relay","cardano node","cardano stake pool","rasbperry pi","armada alliance","ubuntu"]},l="Pi-Relay",i={unversionedId:"stake-pool-guides/pi-pool-tutorial/pi-node-full-guide/pi-relay",id:"stake-pool-guides/pi-pool-tutorial/pi-node-full-guide/pi-relay",title:"Pi-Relay",description:"Turn Pi-Node into an active Cardano relay",source:"@site/docs/stake-pool-guides/pi-pool-tutorial/pi-node-full-guide/pi-relay.md",sourceDirName:"stake-pool-guides/pi-pool-tutorial/pi-node-full-guide",slug:"/stake-pool-guides/pi-pool-tutorial/pi-node-full-guide/pi-relay",permalink:"/docs/stake-pool-guides/pi-pool-tutorial/pi-node-full-guide/pi-relay",draft:!1,editUrl:"https://github.com/armada-alliance/docs/edit/master/docs/stake-pool-guides/pi-pool-tutorial/pi-node-full-guide/pi-relay.md",tags:[],version:"current",frontMatter:{description:"Turn Pi-Node into an active Cardano relay",keywords:["guides","cardano relay","cardano node","cardano stake pool","rasbperry pi","armada alliance","ubuntu"]},sidebar:"tutorialSidebar",previous:{title:"Environment Setup",permalink:"/docs/stake-pool-guides/pi-pool-tutorial/pi-node-full-guide/environment-setup"},next:{title:"Pi-Core",permalink:"/docs/stake-pool-guides/pi-pool-tutorial/pi-node-full-guide/core-online"}},s={},p=[{value:"1. Configure hostname",id:"1-configure-hostname",level:2},{value:"2. Network",id:"2-network",level:2},{value:"2.1 Configure static IP",id:"21-configure-static-ip",level:3},{value:"2.2 Configure service port",id:"22-configure-service-port",level:3},{value:"2.3 Forward port on router",id:"23-forward-port-on-router",level:3},{value:"2.4 Topology Updater",id:"24-topology-updater",level:3},{value:"3. Enable cron job",id:"3-enable-cron-job",level:2},{value:"4. Wait for service on boarding (4 hours).",id:"4-wait-for-service-on-boarding-4-hours",level:2},{value:"5. Prune list of best (8) peers.",id:"5-prune-list-of-best-8-peers",level:2},{value:"6. Enable blockfetch tracing",id:"6-enable-blockfetch-tracing",level:2},{value:"7. Edit the alias name for Prometheus",id:"7-edit-the-alias-name-for-prometheus",level:2},{value:"8. Reboot",id:"8-reboot",level:2}],c={toc:p};function u(e){let{components:t,...a}=e;return(0,o.kt)("wrapper",(0,n.Z)({},c,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"pi-relay"},"Pi-Relay"),(0,o.kt)("p",null,"To turn Pi-Node into an active relay we have to follow the following steps:"),(0,o.kt)("h2",{id:"1-configure-hostname"},"1. Configure hostname"),(0,o.kt)("p",null,"To set a fully qualified domain name (FQDN) for our relay edit /etc/hostname & /etc/hosts."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo nano /etc/hostname\n")),(0,o.kt)("p",null,"Replace ubuntu with your desired FQDN."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"r1.example.com\n")),(0,o.kt)("p",null,"Save and exit."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo nano /etc/hosts\n")),(0,o.kt)("p",null,"Edit the file accordingly, take note that you may not be using the 192.168.1.xxx IP range."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="/etc/hosts"',title:'"/etc/hosts"'},"127.0.0.1 localhost\n127.0.1.1 r1.example.com r1\n\n# The following lines are desirable for IPv6 capable hosts\n::1 ip6-localhost ip6-loopback\nfe00::0 ip6-localnet\nff00::0 ip6-mcastprefix\nff02::1 ip6-allnodes\nff02::2 ip6-allrouters\nff02::3 ip6-allhosts\n\n")),(0,o.kt)("p",null,"Save and exit."),(0,o.kt)("h2",{id:"2-network"},"2. Network"),(0,o.kt)("h3",{id:"21-configure-static-ip"},"2.1 Configure static IP"),(0,o.kt)("p",null,"Open ",(0,o.kt)("strong",{parentName:"p"},"50-cloud-init.yaml")," and replace the contents of the file with below."),(0,o.kt)("admonition",{title:"Netplan configuration examples",type:"tip"},(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("a",{parentName:"p",href:"https://netplan.io/examples/"},"Netplan configuration examples"))),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"Be sure to use an address on your LAN subnet. In this example I am using ",(0,o.kt)("strong",{parentName:"p"},"192.168.1.xxx"),". Your network may very well be using a different private range.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo nano /etc/netplan/50-cloud-init.yaml\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="/etc/netplan/50-cloud-init.yaml"',title:'"/etc/netplan/50-cloud-init.yaml"'},"# This file is generated from information provided by the datasource.  Changes\n# to it will not persist across an instance reboot.  To disable cloud-init's\n# network configuration capabilities, write a file\n# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:\n# network: {config: disabled}\nnetwork:\n  version: 2\n  renderer: networkd\n  ethernets:\n    eth0:\n      dhcp4: no\n      addresses:\n        - 192.168.1.151/24\n      gateway4: 192.168.1.1\n      nameservers:\n# Home router IP & QUAD9 https://quad9.net/\n          addresses: [192.168.1.1, 9.9.9.9, 149.112.112.112]\n\n")),(0,o.kt)("p",null,"Create a file named ",(0,o.kt)("strong",{parentName:"p"},"99-disable-network-config.cfg")," to disable cloud-init."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo nano /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg\n")),(0,o.kt)("p",null,"Add the following, save and exit."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="/etc/cloud/cloud.cfg.d/99-disable-network-config.cfg"',title:'"/etc/cloud/cloud.cfg.d/99-disable-network-config.cfg"'},"network: {config: disabled}\n")),(0,o.kt)("p",null,"Apply your changes."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"sudo netplan apply\n")),(0,o.kt)("h3",{id:"22-configure-service-port"},"2.2 Configure service port"),(0,o.kt)("p",null,"Open the ~/.adaenv file and change the port it listens on. For R1 or my first relay I will designate port 3001."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"nano $HOME/.adaenv\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="~/.adaenv"',title:'"~/.adaenv"'},"export NODE_PORT=3001\n")),(0,o.kt)("p",null,"Save and exit. ",(0,o.kt)("strong",{parentName:"p"},"ctrl+x then y"),"."),(0,o.kt)("p",null,"Enable cardano-service at boot & restart the service to load changes."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"cardano-service enable\ncardano-service restart\n")),(0,o.kt)("h3",{id:"23-forward-port-on-router"},"2.3 Forward port on router"),(0,o.kt)("admonition",{type:"danger"},(0,o.kt)("p",{parentName:"admonition"},"Do not forward a port to your Core machine it only connects to your relay(s) on your LAN.")),(0,o.kt)("p",null,"Log into your router and forward port 3001 to your relay nodes LAN IPv4 address port 3001. Second relay forward port 3002 to LAN IPv4 address for relay 2 to port 3002."),(0,o.kt)("h3",{id:"24-topology-updater"},"2.4 Topology Updater"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"cd $NODE_HOME/scripts\n")),(0,o.kt)("p",null,"Configure the script to match your environment."),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},'If you are using IPv4 leave CNODE_HOSTNAME the way it is. The service will pick up your public IP address on it\'s own. I repeat only change the port to 3001. For DNS change only the first instance. Do not edit "CHANGE ME" further down in the file.')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"cd ${NODE_HOME}/scripts/\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"nano topologyUpdater.sh\n")),(0,o.kt)("p",null,"Run the updater once to confirm it is working."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"./topologyUpdater.sh\n")),(0,o.kt)("p",null,"Should look similar to this."),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("inlineCode",{parentName:"p"},'{ "resultcode": "201", "datetime":"2021-05-20 10:13:40", "clientIp": "1.2.3.4", "iptype": 4, "msg": "nice to meet you" }'))),(0,o.kt)("h2",{id:"3-enable-cron-job"},"3. Enable cron job"),(0,o.kt)("p",null,"Enable the cron job by removing the # character from crontab."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"crontab -e\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="crontab"',title:'"crontab"'},"33 * * * * /home/ada/pi-pool/scripts/topologyUpdater.sh\n")),(0,o.kt)("p",null,"Save and exit."),(0,o.kt)("h2",{id:"4-wait-for-service-on-boarding-4-hours"},"4. Wait for service on boarding (4 hours)."),(0,o.kt)("p",null,"After four hours of on boarding your relay(s) will start to be available to other peers on the network. ",(0,o.kt)("strong",{parentName:"p"},"topologyUpdater.sh")," will create a list in ${NODE_HOME}/logs."),(0,o.kt)("h2",{id:"5-prune-list-of-best-8-peers"},"5. Prune list of best (8) peers."),(0,o.kt)("p",null,"Open your topolgy file and use ",(0,o.kt)("strong",{parentName:"p"},"ctrl+k")," to cut the entire line of any peer over 5,000 miles away."),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"Remember to remove the last entries comma in your list or cardano-node will fail to start.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"nano ${NODE_HOME}/files/${NODE_CONFIG}-topology.json\n")),(0,o.kt)("h2",{id:"6-enable-blockfetch-tracing"},"6. Enable blockfetch tracing"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},'sed -i ${NODE_FILES}/mainnet-config.json \\\n    -e "s/TraceBlockFetchDecisions\\": false/TraceBlockFetchDecisions\\": true/g"\n')),(0,o.kt)("p",null,"Reboot your new relay and let it sync back to the tip of the chain."),(0,o.kt)("p",null,"Use gLiveView.sh to view peer info."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"cd /home/ada/pi-pool/scripts\n./gLiveView.sh\n")),(0,o.kt)("p",null,"Many operators block icmp syn packets(ping) because of a security flaw that was patched a decade ago. So expect to see --- for RTT because we are not receiving a response from that server."),(0,o.kt)("p",null,"More incoming connections is generally a good thing, it increases the odds that you will get network data sooner. Though you may want to put a limit on how many connect. The only way to stop incoming connections would be to block the IPv4 address with ufw."),(0,o.kt)("h2",{id:"7-edit-the-alias-name-for-prometheus"},"7. Edit the alias name for Prometheus"),(0,o.kt)("p",null,"Last thing we can do is change the alias name Prometheus is serving to Grafana. You will have to go into Grafana and edit the panels alias accordingly as well."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo nano /etc/prometheus/prometheus.yml\n")),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"In an upcoming guide I will show how to have Prometheus running on a separate Pi scraping data from the pool instead of having Prometheus using system resources on those machines."),(0,o.kt)("p",{parentName:"admonition"},"For now you can change the alias name Prometheus is serving to Grafana:"),(0,o.kt)("blockquote",{parentName:"admonition"},(0,o.kt)("p",{parentName:"blockquote"}," alias: 'N1'")),(0,o.kt)("p",{parentName:"admonition"},"to"),(0,o.kt)("blockquote",{parentName:"admonition"},(0,o.kt)("p",{parentName:"blockquote"},"alias: 'R1'"))),(0,o.kt)("admonition",{type:"danger"},(0,o.kt)("p",{parentName:"admonition"},"This is a yaml file and indentation has to be correct.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="/etc/prometheus/prometheus.yml"',title:'"/etc/prometheus/prometheus.yml"'},"global:\n  scrape_interval:     15s # By default, scrape targets every 15 seconds.\n\n  # Attach these labels to any time series or alerts when communicating with\n  # external systems (federation, remote storage, Alertmanager).\n  external_labels:\n    monitor: 'codelab-monitor'\n\n# A scrape configuration containing exactly one endpoint to scrape:\n# Here it's Prometheus itself.\nscrape_configs:\n  # The job name is added as a label job=<job_name> to any timeseries scraped from this config.\n  - job_name: 'Prometheus' # To scrape data from the cardano node\n    scrape_interval: 5s\n    static_configs:\n#      - targets: ['<CORE PRIVATE IP>:12798']\n#        labels:\n#          alias: 'C1'\n#          type:  'cardano-node'\n#      - targets: ['<RELAY PRIVATE IP>:12798']\n#        labels:\n#          alias: 'R1'\n#          type:  'cardano-node'\n      - targets: ['localhost:12798']\n        labels:\n          alias: 'R1'\n          type:  'cardano-node'\n\n#      - targets: ['<CORE PRIVATE IP>:9100']\n#        labels:\n#          alias: 'C1'\n#          type:  'node'\n#      - targets: ['<RELAY PRIVATE IP>:9100']\n#        labels:\n#          alias: 'R1'\n#          type:  'node'\n      - targets: ['localhost:9100']\n        labels:\n          alias: 'R1'\n          type:  'node'\n")),(0,o.kt)("p",null,"Update, save and exit."),(0,o.kt)("h2",{id:"8-reboot"},"8. Reboot"),(0,o.kt)("p",null,"Reboot the server and give it a while to sync back up. That is just about it. Please feel free to join our Telegram channel for support. ",(0,o.kt)("a",{parentName:"p",href:"https://t.me/armada_alli"},"https://t.me/armada_alli")))}u.isMDXComponent=!0}}]);