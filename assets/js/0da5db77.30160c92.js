"use strict";(self.webpackChunkarmada_alliance_docusaurus=self.webpackChunkarmada_alliance_docusaurus||[]).push([[2677],{1690:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>s,metadata:()=>i,toc:()=>d});var n=o(4848),a=o(8453);const s={description:"How to add adapools.org summary.json info to your Grafana instance."},r="Add adapools Metrics to Grafana",i={id:"stake-pool-guides/add-adapools-info-to-grafana",title:"Add adapools Metrics to Grafana",description:"How to add adapools.org summary.json info to your Grafana instance.",source:"@site/docs/stake-pool-guides/add-adapools-info-to-grafana.md",sourceDirName:"stake-pool-guides",slug:"/stake-pool-guides/add-adapools-info-to-grafana",permalink:"/docs/stake-pool-guides/add-adapools-info-to-grafana",draft:!1,unlisted:!1,editUrl:"https://github.com/armada-alliance/docs/edit/master/docs/stake-pool-guides/add-adapools-info-to-grafana.md",tags:[],version:"current",frontMatter:{description:"How to add adapools.org summary.json info to your Grafana instance."}},l={},d=[{value:"Assumptions",id:"assumptions",level:2},{value:"Make New Directory",id:"make-new-directory",level:2},{value:"Get adapools Summary File",id:"get-adapools-summary-file",level:2},{value:"Create crontab Entry",id:"create-crontab-entry",level:2},{value:"Run node exporter Command",id:"run-node-exporter-command",level:2}];function c(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.h1,{id:"add-adapools-metrics-to-grafana",children:"Add adapools Metrics to Grafana"}),"\n",(0,n.jsx)(t.h2,{id:"assumptions",children:"Assumptions"}),"\n",(0,n.jsxs)(t.p,{children:["You have set up a Cardano node using one of the tutorials provided ",(0,n.jsx)(t.a,{href:"pi-pool-tutorial/",children:"here"}),". If so, you should have the necessary dependencies installed that the steps below utilize. If not, install the following packages:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",metastring:'title=">_Terminal"',children:"sudo apt install build-essential libssl-dev tcptraceroute python3-pip \\\n         jq make automake unzip net-tools nginx ssl-cert pkg-config \\\n         libffi-dev libgmp-dev libssl-dev libtinfo-dev libsystemd-dev \\\n         zlib1g-dev g++ libncursesw5 libtool autoconf -y\n"})}),"\n",(0,n.jsx)(t.h2,{id:"make-new-directory",children:"Make New Directory"}),"\n",(0,n.jsxs)(t.p,{children:["To start, pick a location on the machine that is running Grafana where you will create a new directory for the node exporter to use. The node exporter is likely located in /opt/cardano/monitoring/",(0,n.jsx)(t.strong,{children:"node_exporter"})," given the pi-pool default location. __If not, see if you can find it using the \"which node_exporter\" command. If that doesn't find it, the directory where it's located is not on your $PATH and you'll need to dig deeper. ",(0,n.jsx)(t.a,{href:"https://github.com/prometheus/node_exporter",children:"Check this git"})," for more information."]}),"\n",(0,n.jsx)(t.p,{children:"Change to the location for the new directory, here I'm selecting the local bin for my user."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",metastring:'title=">_Terminal"',children:"cd $HOME/.local/bin\n"})}),"\n",(0,n.jsxs)(t.p,{children:["Now make a new directory here where we can store custom text file stats that the node_exporter will parse. I'm calling the directory ",(0,n.jsx)(t.strong,{children:"customStats"}),", but you can name it whatever you like."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",metastring:'title=">_Terminal"',children:"mkdir customStats\n"})}),"\n",(0,n.jsx)(t.h2,{id:"get-adapools-summary-file",children:"Get adapools Summary File"}),"\n",(0,n.jsxs)(t.p,{children:["The adapools.org site provides a ",(0,n.jsx)(t.strong,{children:"summary.json"})," file for every registered pool. We'll use this file to parse out the data we want and store it in our directory we just created. We can create a bash script to handle this for us. I'm in my $HOME/.local/bin directory:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",metastring:'title=">_Terminal"',children:"nano getAdaPoolsSummary.sh\n"})}),"\n",(0,n.jsxs)(t.p,{children:["Add this content below, replace ",(0,n.jsx)(t.strong,{children:"YOUR POOL ID"})," with your pool's ID, save and exit. Essentially this pulls a copy of the ",(0,n.jsx)(t.strong,{children:"summary.json"})," file for your pool, removes some things that the node exporter cannot parse (string values) and saves a copy in our new directory."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:"curl https://js.adapools.org/pools/<YOUR POOL ID>/summary.json 2>/dev/null \\\n| jq '.data | del(.direct, .hist_bpe, .handles, .hist_roa, .db_ticker, .db_name, .db_description, .db_url, .ticker_orig, .pool_id, .pool_id_bech32, .group_basic)' \\\n| tr -d \\\"{},: \\\n| awk NF \\\n| sed -e 's/^[ \\t]*/adapools_/' > $HOME/.local/bin/customStats/adapools.prom\n"})}),"\n",(0,n.jsxs)(t.p,{children:["Now when the ",(0,n.jsx)(t.strong,{children:"getAdaPoolsSummary.sh"})," is run it'll refresh a file called ",(0,n.jsx)(t.strong,{children:"adapools.prom"})," in our new directory. This file will contain metrics that start with the term ",(0,n.jsx)(t.strong,{children:"adapools"})," and will be visible in the Grafana query builder metrics section as such."]}),"\n",(0,n.jsx)(t.admonition,{type:"caution",children:(0,n.jsx)(t.p,{children:"It's important that the results in the file do not include string values. The node exporter will throw an error and you won't see the adapools metrics."})}),"\n",(0,n.jsxs)(t.p,{children:['If you discover string values, you can remove them by adding a new key to the "del" section in the script above. For example, to remove the ',(0,n.jsx)(t.strong,{children:"adapools_db_description"})," metric (has a string value), you'd add ",(0,n.jsx)(t.strong,{children:".db_description"})," to the ",(0,n.jsx)(t.strong,{children:"del( )"})," section."]}),"\n",(0,n.jsx)(t.h2,{id:"create-crontab-entry",children:"Create crontab Entry"}),"\n",(0,n.jsx)(t.p,{children:"Depending on how often you want to refresh a copy of these stats, you can create a local crontab entry to pull a fresh copy of the adapools.prom file."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",metastring:'title=">_Terminal"',children:"crontab -e\n"})}),"\n",(0,n.jsxs)(t.p,{children:["The following line ",(0,n.jsx)(t.strong,{children:"runs the script we created every 5 minutes"}),". Add the line, save and exit. Since this data doesn't change that often, you shouldn't need to pull it that often. Don't piss off the adapools.org folks by pulling this data every 5 seconds - it's not necessary. For other examples of crontab run times, ",(0,n.jsx)(t.a,{href:"https://crontab.tech/examples",children:"see this lovely link"}),"."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",metastring:'title="Crontab"',children:"*/5 * * * * $HOME/.local/bin/getAdaPoolsSummary.sh\n"})}),"\n",(0,n.jsx)(t.h2,{id:"run-node-exporter-command",children:"Run node exporter Command"}),"\n",(0,n.jsxs)(t.p,{children:["Now that we are generating the ",(0,n.jsx)(t.strong,{children:"adapools.prom"})," file, we need to tell the node exporter where to find our custom text file. Depending on how you are running your node exporter instance, you'll need to add the following command line parameters. This might be found in the ",(0,n.jsx)(t.strong,{children:"startMonitor"})," script included with the pi-pool default build."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",metastring:'title=">_Terminal"',children:"node_exporter --collector.textfile.directory=$HOME/.local/bin/customStats --collector.textfile\n"})}),"\n",(0,n.jsxs)(t.p,{children:["If all goes as planned, you should be able to pull up this URL in your browser and see the new ",(0,n.jsx)(t.strong,{children:"adapools"})," metrics. If this worked, your new metrics should be visible in the Grafana query builder."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:"http://<YOUR GRAFANA NODE IP>:9100/metrics\n"})}),"\n",(0,n.jsx)(t.admonition,{type:"info",children:(0,n.jsxs)(t.p,{children:["There are other methods you could use to implement this approach. Basically, if you can create a text file with key/value pairs and put it into this new directory, the node exporter should pull the data into Grafana. It opens up a vast array of possibilities. Just ensure you prefix the label names with a unique value (the ",(0,n.jsx)(t.strong,{children:"adapools_"})," __part in the adapools.prom file above) per file."]})}),"\n",(0,n.jsxs)(t.p,{children:["Was this information helpful? Earn rewards with us! ",(0,n.jsx)(t.a,{href:"/docs/delegate",children:"Consider delegating some ADA"}),"."]})]})}function h(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(c,{...e})}):c(e)}},8453:(e,t,o)=>{o.d(t,{R:()=>r,x:()=>i});var n=o(6540);const a={},s=n.createContext(a);function r(e){const t=n.useContext(s);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),n.createElement(s.Provider,{value:t},e.children)}}}]);