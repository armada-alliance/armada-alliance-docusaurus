"use strict";(self.webpackChunkarmada_alliance_docusaurus=self.webpackChunkarmada_alliance_docusaurus||[]).push([[1676],{4736:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>c});var t=a(4848),s=a(8453);const o={description:"Securing Stakepool Connections & Monitoring within a VPN, Prometheus & Grafana Metrics, Alerting to Telegram"},i="Securing Stakepool Connections & Monitoring with Tailscale",r={id:"stake-pool-guides/monitor-alert",title:"Securing Stakepool Connections & Monitoring with Tailscale",description:"Securing Stakepool Connections & Monitoring within a VPN, Prometheus & Grafana Metrics, Alerting to Telegram",source:"@site/docs/stake-pool-guides/monitor-alert.mdx",sourceDirName:"stake-pool-guides",slug:"/stake-pool-guides/monitor-alert",permalink:"/docs/stake-pool-guides/monitor-alert",draft:!1,unlisted:!1,editUrl:"https://github.com/armada-alliance/docs/edit/master/docs/stake-pool-guides/monitor-alert.mdx",tags:[],version:"current",frontMatter:{description:"Securing Stakepool Connections & Monitoring within a VPN, Prometheus & Grafana Metrics, Alerting to Telegram"},sidebar:"tutorialSidebar",previous:{title:"Networking",permalink:"/docs/networking-guides/"},next:{title:"Basic Stake Pool Networking",permalink:"/docs/stake-pool-guides/basic-stake-pool-networking"}},l={},c=[{value:"Creating a Tailscale VPN",id:"creating-a-tailscale-vpn",level:2},{value:"Adding Machines",id:"adding-machines",level:3},{value:"Disable Key Expiry",id:"disable-key-expiry",level:3},{value:"Access Control layer",id:"access-control-layer",level:3},{value:"Update cardano-node topology files.",id:"update-cardano-node-topology-files",level:3},{value:"Example with block producer &amp; backup block producer in localRoots using the tailscale0 interface IPv4.",id:"example-with-block-producer--backup-block-producer-in-localroots-using-the-tailscale0-interface-ipv4",level:4},{value:"Monitoring",id:"monitoring",level:2},{value:"Prometheus &amp; Grafana",id:"prometheus--grafana",level:3},{value:"Install Prometheus.",id:"install-prometheus",level:3},{value:"Configure Prometheus",id:"configure-prometheus",level:3},{value:"Install Grafana",id:"install-grafana",level:3},{value:"Dashboard/s",id:"dashboards",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",img:"img",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"securing-stakepool-connections--monitoring-with-tailscale",children:"Securing Stakepool Connections & Monitoring with Tailscale"}),"\n",(0,t.jsxs)(n.p,{children:["This guide will demonstrate how to use ",(0,t.jsx)(n.a,{href:"https://tailscale.com",children:"Tailscale"})," to manage a ",(0,t.jsx)(n.a,{href:"https://www.wireguard.com/",children:"WireGuard"})," VPN, securely connecting your\nblock producer and relays. You will learn to scrape data with ",(0,t.jsx)(n.a,{href:"https://prometheus.io/",children:"Prometheus"})," and display it using ",(0,t.jsx)(n.a,{href:"https://grafana.com/",children:"Grafana"}),"\nwithin the VPN, without the need to manage TLS certificates or opening any ports except the public ports for your relays."]}),"\n",(0,t.jsxs)(n.p,{children:["Additionally, the guide covers setting up Grafana ",(0,t.jsx)(n.a,{href:"https://grafana.com/docs/grafana/latest/alerting/",children:"alerts"})," and configuring\n",(0,t.jsx)(n.a,{href:"https://grafana.com/docs/grafana/latest/alerting/configure-notifications/",children:"notifications"})," to be sent to a Telegram bot.\nThis bot can then be added to a Telegram group for real-time alerting."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:a(7663).A+"",width:"1434",height:"2461"})}),"\n",(0,t.jsx)(n.admonition,{type:"info",children:(0,t.jsxs)(n.p,{children:["More information on the various ",(0,t.jsx)(n.a,{href:"https://grafana.com/docs/grafana/latest/alerting/configure-notifications/manage-contact-points/",children:"notification contact points"}),"\nsupported by Grafana, including Telegram, Email, Discord, and others."]})}),"\n",(0,t.jsxs)(n.admonition,{type:"tip",children:[(0,t.jsx)(n.p,{children:"It is best to have Grafana and Prometheus on their own dedicated machine outside of the block producers local network or set them up on a relay looking in.\nThis way you can be alerted if the BP loses connectivity."}),(0,t.jsx)(n.p,{children:"You can also have several instances of Grafana on different machines using the same Prometheus data source. I do this so I can always have Grafana locally for my\nviewing pleasure. It loads a lot faster when it's local \ud83d\ude0e. Alerting only needs to be setup on the one looking in."})]}),"\n",(0,t.jsx)(n.h2,{id:"creating-a-tailscale-vpn",children:"Creating a Tailscale VPN"}),"\n",(0,t.jsxs)(n.p,{children:["Head over to the ",(0,t.jsx)(n.a,{href:"https://tailscale.com/kb/1017/install",children:"Tailscale quick start page"}),", create an account and start adding machines.\nStart by adding your local machine or laptop. It is very easy to install Tailscale on your machines just follow the instructions. You can also install it on your phone\nto view dashboard on the go."]}),"\n",(0,t.jsx)(n.p,{children:'This guide will also make your block producer "portable". Meaning you can connect your block producer to the internet from anywhere and it will instantly\nreestablish communication with your relays without further configuration \u26a1.'}),"\n",(0,t.jsx)(n.h3,{id:"adding-machines",children:"Adding Machines"}),"\n",(0,t.jsx)(n.p,{children:"Follow the instructions for adding the nodes that make up your pool and a machine to host Grafana. This does not have to be a separate machine,\nthough as mentioned above, it's preferable to have it looking in at the block producer. This way, if the BP goes offline, you will still be able to receive alerts."}),"\n",(0,t.jsx)(n.p,{children:"Installing Tailscale on Ubuntu is just running the below script then visiting the link that is output to terminal and authorizing the machine on the Tailscale website."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"curl -fsSL https://tailscale.com/install.sh | sh\n"})}),"\n",(0,t.jsxs)(n.p,{children:["You will see a new ",(0,t.jsx)(n.code,{children:"tailscale0"})," network interface added to each machine. You can control traffic to these interfaces\nwith iptables, UFW, or Firewalld on the ",(0,t.jsx)(n.code,{children:"tailscale0"})," interface. Additionally, you can use Tailscale's ACL feature to group machines and control which\nports are open between machines in that group."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"ip a\n"})}),"\n",(0,t.jsx)(n.h3,{id:"disable-key-expiry",children:"Disable Key Expiry"}),"\n",(0,t.jsx)(n.admonition,{type:"caution",children:(0,t.jsx)(n.p,{children:"Failure to disable key expiry will knock your pool offline when they expire after 90 days. Don't skip this step. You have been warned."})}),"\n",(0,t.jsxs)(n.p,{children:["Once the machines are added you should disable key expiry on each machine or the keys used to connect to the VPN will expire after 90 days and those\nnodes will be unable to connect. You can do this on the ",(0,t.jsx)(n.a,{href:"https://tailscale.com",children:"Tailscale"})," website by clicking the ... for each machine and choosing 'Disable key expiry'.\nYou can always generate new keys at any time if you wish. If you do get locked out you can toggle the expiry on the website and restart the server to get back into it."]}),"\n",(0,t.jsx)(n.h3,{id:"access-control-layer",children:"Access Control layer"}),"\n",(0,t.jsxs)(n.p,{children:["Click the 'Access controls' tab on the ",(0,t.jsx)(n.a,{href:"https://tailscale.com",children:"Tailscale"})," website. By default there is a rule to allow all traffic on all ports between the machines in the tailnet.\nThis is fine to get started but know you have the ability to group machines and only allow certain ports to communicate through the VPN to machines in that group.\nFor example I have a mainnet and a testnet group and only allow the ports needed for those machines."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'        // my laptop does what it wants\n\t\t{"action": "accept", "src": ["tag:kingOfKings"], "dst": ["*:*"]},\n\t\t{\n\t\t\t"action": "accept",\n\t\t\t"src":    ["autogroup:members"],\n\t\t\t"dst":    ["autogroup:internet:*"],\n\t\t},\n\t\t{ // mainnet machines can communicate on said ports\n\t\t\t"action": "accept",\n\t\t\t"src":    ["tag:cardano-mainnet"],\n\t\t\t"dst": ["tag:cardano-mainnet:6000-6003,9090,5000,12798,12800,9100,9190,3000,1337,9615"],\n\t\t},\n\t\t{ // testnet machines can communicate on said ports\n\t\t\t"action": "accept",\n\t\t\t"src":    ["tag:cardano-testnets"],\n\t\t\t"dst":    ["tag:cardano-preview:3000-3003,9090,5000,12798,12800,9100,22"],\n\t\t}\n'})}),"\n",(0,t.jsx)(n.p,{children:"This is just an example of what my groups look like. Consult the documentation on ACL when you are ready to tighten up access.\nBe aware that ports are closed by default and that one default rule is what is allowing communication for all machines on all ports."}),"\n",(0,t.jsx)(n.h3,{id:"update-cardano-node-topology-files",children:"Update cardano-node topology files."}),"\n",(0,t.jsx)(n.p,{children:"You can get a list of the machine names, IP address' and some other connection info of the machines in your 'tailnet' from their website or by running.."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo tailscale status\n"})}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsx)(n.p,{children:"You can remove HOSTADDR=0.0.0.0 entirely from your cardano-node startup script(if present) to enable connections using Tailscale's IPv6 address'. cardano-node will\nuse both IPv4 and IPv6 if that line is not present."})}),"\n",(0,t.jsx)(n.p,{children:"Let's test communication. When you setup Tailscale it creates a nameserver that the VPN can use to resolve machine hostnames to their VPN IP address.\nYou should be able to ping or SSH to the IPv4, IPv6 address or machine name of a node from other machines in the VPN. You can also use cardano-cli to test\nthey can connect before editing your topology files."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"cardano-cli ping -h <Tailscale IP or Tailscale DNS name> -p <port>\n"})}),"\n",(0,t.jsx)(n.p,{children:"Test this out on each machine. You can then go in to your cardano-node topology file and update all the address to their Tailscale IP."}),"\n",(0,t.jsx)(n.h4,{id:"example-with-block-producer--backup-block-producer-in-localroots-using-the-tailscale0-interface-ipv4",children:"Example with block producer & backup block producer in localRoots using the tailscale0 interface IPv4."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'    "localRoots": [\n    { "accessPoints": [\n      { "address": "100.90.109.57", "port": 6000, "name": "My core" },\n      { "address": "100.118.76.131", "port": 6000, "name": "Backup core" }\n      ],\n      "advertise": false,\n      "trustable": true,\n      "valency": 2\n    },\n    ]\n'})}),"\n",(0,t.jsx)(n.h2,{id:"monitoring",children:"Monitoring"}),"\n",(0,t.jsx)(n.p,{children:"We first need to tell cardano-node to have the metrics available to all interfaces and not just localhost. This way Prometheus will be able to access the\nmetrics when Prometheus is on another machine. Open cardano-node's config.json and update the hasPrometheus section like this. Do this for all the\nmachines running cardano-node. Keep in mind you'll need to do this every time you pull in a new config.json when upgrading."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'  "hasPrometheus": [\n    "0.0.0.0",\n    12798\n  ],\n'})}),"\n",(0,t.jsx)(n.p,{children:"Next make sure you have prometheus-node-exporter installed on every machine you plan to add to the dashboard."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"sudo apt install prometheus-node-exporter\nsudo systemctl enable prometheus-node-exporter.service\n"})}),"\n",(0,t.jsx)(n.h3,{id:"prometheus--grafana",children:"Prometheus & Grafana"}),"\n",(0,t.jsx)(n.p,{children:"Prometheus scrapes data from cardano-node and the Linux host with node exporter and serves the scraped metrics over http. Grafana in turn can use that data to\ndisplay graphs and create alerts etc. Our Grafana dashboard will be made up of data from our Ubuntu system(prometheus-node-exporter) & cardano-node."}),"\n",(0,t.jsx)(n.admonition,{title:"PROMETHEUS REPOSITORY",type:"info",children:(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"https://github.com/prometheus",children:"https://github.com/prometheus"})})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:a(2486).A+"",width:"1907",height:"980"})}),"\n",(0,t.jsx)(n.h3,{id:"install-prometheus",children:"Install Prometheus."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"sudo apt install prometheus\n"})}),"\n",(0,t.jsx)(n.h3,{id:"configure-prometheus",children:"Configure Prometheus"}),"\n",(0,t.jsx)(n.p,{children:"Open prometheus.yml."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"sudo nano /etc/prometheus/prometheus.yml\n"})}),"\n",(0,t.jsx)(n.admonition,{type:"caution",children:(0,t.jsx)(n.p,{children:"Indentation must be correct YAML format or Prometheus will fail to start."})}),"\n",(0,t.jsx)(n.p,{children:"Replace the contents of the file with below make sure you fill in the Tailscale ipv4 address for each machine twice. Once for cardano-node metrics and\nthen again for prometheus node exporter metrics. Which is just server metrics like RAM, CPU etc."}),"\n",(0,t.jsx)(n.admonition,{type:"info",children:(0,t.jsx)(n.p,{children:"If you have other machines or services you would like to add to your dashboard you can add them here. Mithril, Aya devnet, testnets etc."})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",metastring:'title="/etc/prometheus/prometheus.yml"',children:"global:\n  scrape_interval:     5s # By default, scrape targets every 15 seconds.\n\n  # Attach these labels to any time series or alerts when communicating with\n  # external systems (federation, remote storage, Alertmanager).\n  external_labels:\n    monitor: 'codelab-monitor'\n\n# A scrape configuration containing exactly one endpoint to scrape:\n# Here it's Prometheus itself.\nscrape_configs:\n  # The job name is added as a label job=<job_name> to any timeseries scraped from this config.\n  - job_name: 'prometheus' # To scrape data from the cardano node\n    scrape_interval: 5s\n    static_configs:\n\n    # cardano-node metrics\n\n      - targets: ['<primary core ip addr>:12798']\n        labels:\n          alias: 'C1'\n          type:  'cardano-node'\n\n      - targets: ['<backup core ip addr>:12798']\n        labels:\n          alias: 'C2'\n          type:  'cardano-node'\n\n      - targets: ['<relay 1 ip addr>:12798']\n        labels:\n          alias: 'R1'\n          type:  'cardano-node'\n\n      - targets: ['<relay 2 ip addr>:12798']\n        labels:\n          alias: 'R2'\n          type:  'cardano-node'\n\n      - targets: ['<relay 3 ip addr>:12798']\n        labels:\n          alias: 'R3'\n          type:  'cardano-node'\n\n    # prometheus node exporter metrics\n\n      - targets: ['<primary core ip addr>:9100']\n        labels:\n          alias: 'C1'\n          type:  'node'\n\n      - targets: ['<backup core ip addr>:9100']\n        labels:\n          alias: 'C2'\n          type:  'node'\n\n      - targets: ['<relay 1 ip addr>:9100']\n        labels:\n          alias: 'R1'\n          type:  'node'\n\n      - targets: ['<relay 2 ip addr>:9100']\n        labels:\n          alias: 'R2'\n          type:  'node'\n\n      - targets: ['<relay 3 ip addr>:9100']\n        labels:\n          alias: 'R3'\n          type:  'node'\n\n"})}),"\n",(0,t.jsx)(n.p,{children:"Save & exit."}),"\n",(0,t.jsx)(n.p,{children:"Start Prometheus, you can check if it's running and follow the services logs with."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"sudo systemctl start prometheus.service\nsudo systemctl status prometheus.service\njournalctl -u prometheus.service -f\n"})}),"\n",(0,t.jsx)(n.p,{children:"If everything looks good tell Systemd to start the service at boot."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"sudo systemctl enable prometheus.service\n"})}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsxs)(n.p,{children:["You can now open the browser on your laptop if Tailscale is installed on it and got to ",(0,t.jsx)(n.a,{href:"http://prometheus-server-ip:9090",children:"http://prometheus-server-ip:9090"})]})}),"\n",(0,t.jsx)(n.h3,{id:"install-grafana",children:"Install Grafana"}),"\n",(0,t.jsx)(n.admonition,{title:"GRAFANA REPOSITORY",type:"info",children:(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"https://github.com/grafana/grafana",children:"https://github.com/grafana/grafana"})})}),"\n",(0,t.jsx)(n.p,{children:"Install the prerequisite packages."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo apt install -y apt-transport-https software-properties-common wget\n"})}),"\n",(0,t.jsx)(n.p,{children:"Import Grafana's gpg key to Ubuntu."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"sudo mkdir -p /etc/apt/keyrings/\nwget -q -O - https://apt.grafana.com/gpg.key | gpg --dearmor | sudo tee /etc/apt/keyrings/grafana.gpg > /dev/null\n"})}),"\n",(0,t.jsx)(n.p,{children:"Add latest stable repo to apt sources."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:'echo "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main" | sudo tee -a /etc/apt/sources.list.d/grafana.list\n'})}),"\n",(0,t.jsx)(n.p,{children:"Update your package lists & install Grafana."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"sudo apt update; sudo apt install grafana\n"})}),"\n",(0,t.jsx)(n.p,{children:"Optionally, change the port on which Grafana listens to port 5000 to avoid clashes with cardano-node, which commonly uses port 3000."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:'sudo sed -i /etc/grafana/grafana.ini \\\n         -e "s#;http_port#http_port#" \\\n         -e "s#3000#5000#"\n'})}),"\n",(0,t.jsx)(n.p,{children:"Start Grafana, you can check if it's running and follow the services logs with."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"sudo systemctl start grafana-server.service\nsudo systemctl status grafana-server.service\njournalctl -u grafana-server.service -f\n"})}),"\n",(0,t.jsx)(n.p,{children:"If everything looks good tell Systemd to start the service at boot."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"sudo systemctl enable grafana-server.service\n"})}),"\n",(0,t.jsx)(n.h2,{id:"dashboards",children:"Dashboard/s"})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},7663:(e,n,a)=>{a.d(n,{A:()=>t});const t=a.p+"assets/images/catallyst-5node-dashboard-b32fd4286b8b1c2dec579519443ff99f.png"},2486:(e,n,a)=>{a.d(n,{A:()=>t});const t=a.p+"assets/images/pi-pool-grafana-55cbdd28508cd62938e7317a2e234d78.png"},8453:(e,n,a)=>{a.d(n,{R:()=>i,x:()=>r});var t=a(6540);const s={},o=t.createContext(s);function i(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);