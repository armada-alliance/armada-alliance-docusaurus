"use strict";(self.webpackChunkarmada_alliance_docusaurus=self.webpackChunkarmada_alliance_docusaurus||[]).push([[4313],{3905:(e,t,a)=>{a.d(t,{Zo:()=>d,kt:()=>m});var n=a(7294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var l=n.createContext({}),p=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},d=function(e){var t=p(e.components);return n.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),u=p(a),m=o,h=u["".concat(l,".").concat(m)]||u[m]||c[m]||r;return a?n.createElement(h,i(i({ref:t},d),{},{components:a})):n.createElement(h,i({ref:t},d))}));function m(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=a.length,i=new Array(r);i[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var p=2;p<r;p++)i[p]=a[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}u.displayName="MDXCreateElement"},3333:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>c,frontMatter:()=>r,metadata:()=>s,toc:()=>p});var n=a(7462),o=(a(7294),a(3905));const r={description:"Raspberry Pi OS Cardano Stakepool"},i="Raspi-Node Guide",s={unversionedId:"stake-pool-guides/Raspberry-pi-os",id:"stake-pool-guides/Raspberry-pi-os",title:"Raspi-Node Guide",description:"Raspberry Pi OS Cardano Stakepool",source:"@site/docs/stake-pool-guides/Raspberry-pi-os.md",sourceDirName:"stake-pool-guides",slug:"/stake-pool-guides/Raspberry-pi-os",permalink:"/docs/stake-pool-guides/Raspberry-pi-os",draft:!1,editUrl:"https://github.com/armada-alliance/docs/edit/master/docs/stake-pool-guides/Raspberry-pi-os.md",tags:[],version:"current",frontMatter:{description:"Raspberry Pi OS Cardano Stakepool"},sidebar:"tutorialSidebar",previous:{title:"Introduction",permalink:"/docs/stake-pool-guides/pi-pool-tutorial/pi-node-full-guide/stakepoolscripts"},next:{title:"Alpine Linux OS",permalink:"/docs/stake-pool-guides/alpine-linux-os"}},l={},p=[{value:"Why this guide?",id:"why-this-guide",level:2},{value:"Download &amp; Flash",id:"download--flash",level:2},{value:"Install Raspi-Imager",id:"install-raspi-imager",level:3},{value:"Create the ada user",id:"create-the-ada-user",level:3},{value:"Change password",id:"change-password",level:4},{value:"Delete the pi user",id:"delete-the-pi-user",level:4},{value:"Server setup",id:"server-setup",level:3},{value:"Configure Hardware",id:"configure-hardware",level:3},{value:"Configure Raspbian",id:"configure-raspbian",level:3},{value:"Disable the root user",id:"disable-the-root-user",level:4},{value:"Secure shared memory",id:"secure-shared-memory",level:4},{value:"Increase open file limit for $USER",id:"increase-open-file-limit-for-user",level:4},{value:"Optimize performance &amp; security",id:"optimize-performance--security",level:4},{value:"Chrony",id:"chrony",level:4},{value:"Zram swap",id:"zram-swap",level:4},{value:"Install packages",id:"install-packages",level:3},{value:"Automatic security updates",id:"automatic-security-updates",level:3},{value:"Environment Setup",id:"environment-setup",level:2},{value:"description: Configure the environment for Cardano Node",id:"description-configure-the-environment-for-cardano-node",level:3},{value:"Choose testnet or mainnet.",id:"choose-testnet-or-mainnet",level:3},{value:"Create bash variables &amp; add ~/.local/bin to our $PATH \ud83c\udfc3",id:"create-bash-variables--add-localbin-to-our-path-",level:4},{value:"Build Libsodium",id:"build-libsodium",level:3},{value:"Retrieve node files",id:"retrieve-node-files",level:4},{value:"Retrieve aarch64 1.33.1 and cardano-submit-api binaries",id:"retrieve-aarch64-1331-and-cardano-submit-api-binaries",level:4},{value:"Systemd unit startup scripts",id:"systemd-unit-startup-scripts",level:4},{value:"\u26d3 Syncing the chain \u26d3",id:"-syncing-the-chain-",level:3},{value:"Download snapshot",id:"download-snapshot",level:4},{value:"gLiveView.sh",id:"gliveviewsh",level:3},{value:"topologyUpdater.sh",id:"topologyupdatersh",level:3},{value:"Prometheus, Node Exporter &amp; Grafana",id:"prometheus-node-exporter--grafana",level:3},{value:"Install Prometheus &amp; Node Exporter.",id:"install-prometheus--node-exporter",level:4},{value:"Configure Prometheus",id:"configure-prometheus",level:4},{value:"Install Grafana",id:"install-grafana",level:4},{value:"cardano-monitor bash function",id:"cardano-monitor-bash-function",level:4},{value:"Grafana, Nginx proxy_pass &amp; snakeoil",id:"grafana-nginx-proxy_pass--snakeoil",level:3},{value:"Configure Grafana",id:"configure-grafana",level:4},{value:"Configure poolDataLive",id:"configure-pooldatalive",level:4},{value:"Useful Commands",id:"useful-commands",level:3}],d={toc:p};function c(e){let{components:t,...r}=e;return(0,o.kt)("wrapper",(0,n.Z)({},d,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"raspi-node-guide"},"Raspi-Node Guide"),(0,o.kt)("p",null,(0,o.kt)("img",{src:a(7485).Z,width:"620",height:"349"})),(0,o.kt)("h2",{id:"why-this-guide"},"Why this guide?"),(0,o.kt)("p",null,"This guide is intended for people who wants to get a Raspberry-pi 4 with full desktop Raspberry Pi OS installed along with all the required software to get a Cardano Node up and running on the blockchain. This can be a nice setup for those seeking to just do some lightweight develerpment on the blockchain like making NFTs for example."),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("strong",{parentName:"p"},"You'll need a monitor (at least for initial setup as SSH is disabled and ufw is up) and you must use the Raspberry Pi 4 with 8GB of RAM!"))),(0,o.kt)("h2",{id:"download--flash"},"Download & Flash"),(0,o.kt)("h3",{id:"install-raspi-imager"},"Install Raspi-Imager"),(0,o.kt)("p",null,"Download, install & open ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/raspberrypi/rpi-imager/releases/latest"},"Raspberry Pi Imager"),". Plug in your target USB drive."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"64 bit Raspberry Pi OS desktop")),(0,o.kt)("p",null,"There is now a 64bit image you can install, it is not available in raspi-imager selection, IDK why. Check out the images in the link below grab the latest version. It is a zip file so we have to unzip it before flashing."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://downloads.raspberrypi.org/raspios_arm64"},"Download Raspberry Pi OS arm64")),(0,o.kt)("p",null,"Unzip the img file and flash it with Raspi-imager. Plug it into your Raspberry Pi 4 and go through the initial setup. Default username=",(0,o.kt)("inlineCode",{parentName:"p"},"pi")," and the password=",(0,o.kt)("inlineCode",{parentName:"p"},"raspberrypi")),(0,o.kt)("p",null,"You can find documentation here ",(0,o.kt)("a",{parentName:"p",href:"https://www.raspberrypi.com/documentation/"},"https://www.raspberrypi.com/documentation/")),(0,o.kt)("p",null,"Insert the SSD into one of the blue usb3 ports. Then insert the HDMI, Keyboard, Mouse, Ethernet, and power supply."),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"The first Pi4's to ship did not boot from USB3 by default, nowadays they do. If your image does not boot the two most common issues are older firmware on your Pi or an incompatible USB3 adaptor.")),(0,o.kt)("p",null,(0,o.kt)("img",{src:a(9008).Z,width:"474",height:"338"})),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"All we really need to do here is disable auto-login & create the ada user with sudo privileges. After we log back in we will delete the default Pi user and configure the server & environment for cardano-node & cardano-cli.")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Open the Raspberry Pi Configuration utility.",src:a(9098).Z,width:"804",height:"640"})),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Set Auto Login to Disabled",src:a(9099).Z,width:"548",height:"464"})),(0,o.kt)("h3",{id:"create-the-ada-user"},"Create the ada user"),(0,o.kt)("p",null,"This guide strives to be user agnostic so you can choose a different username and you should be ok. When creating the systemd services however you will have to edit the user. ",(0,o.kt)("strong",{parentName:"p"},"Pay attention!")),(0,o.kt)("p",null,"Open a terminal then create a new user and add it to the sudo group."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo adduser ada; sudo adduser ada sudo\n")),(0,o.kt)("p",null,"Update Raspbery Pi OS and reboot the server to make sure you are on the latest kernel. Reboot and log in as your new user."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo apt update; sudo apt upgrade\n")),(0,o.kt)("h4",{id:"change-password"},"Change password"),(0,o.kt)("p",null,"You can change the users password at anytime with the following command."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"passwd\n")),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"Careful where you use sudo. For example issuing 'sudo passwd' would change the root password. This seems to be a place where new users get confused.")),(0,o.kt)("h4",{id:"delete-the-pi-user"},"Delete the pi user"),(0,o.kt)("p",null,"The pi user is set to auto login and does not require a password for sudo commands. Best to just trash it to avoid any potential security issues."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo deluser --remove-home pi\n")),(0,o.kt)("h3",{id:"server-setup"},"Server setup"),(0,o.kt)("h3",{id:"configure-hardware"},"Configure Hardware"),(0,o.kt)("p",null,"Let's save some power, raise the governor on the CPU a bit, and set GPU ram as low as we can."),(0,o.kt)("p",null,"Here are some links for overclocking and testing your drive speeds. If you have heat sinks you can safely go to 2000. Just pay attention to over volt recommendations to go with your chosen clock speed."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://www.raspberrypi.org/documentation/configuration/config-txt/overclocking.md"},"https://www.raspberrypi.org/documentation/configuration/config-txt/overclocking.md")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://www.seeedstudio.com/blog/2020/02/12/how-to-safely-overclock-your-raspberry-pi-4-to-2-147ghz/"},"https://www.seeedstudio.com/blog/2020/02/12/how-to-safely-overclock-your-raspberry-pi-4-to-2-147ghz/")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://www.tomshardware.com/how-to/raspberry-pi-4-23-ghz-overclock"},"https://www.tomshardware.com/how-to/raspberry-pi-4-23-ghz-overclock")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://dopedesi.com/2020/11/24/upgrade-your-raspberry-pi-4-with-a-nvme-boot-drive-by-alex-ellis-nov-2020/"},"https://dopedesi.com/2020/11/24/upgrade-your-raspberry-pi-4-with-a-nvme-boot-drive-by-alex-ellis-nov-2020/")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://jamesachambers.com/new-raspberry-pi-4-bootloader-usb-network-boot-guide/"},"Legendary Technology: New Raspberry Pi 4 Bootloader USB"))),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Overclock, memory & radios")),(0,o.kt)("p",null,"Edit /boot/config.txt."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo nano /boot/config.txt\n")),(0,o.kt)("p",null,"Just paste the Pi Pool additions in at the bottom."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="/boot/config.txt"',title:'"/boot/config.txt"'},"## Pi Pool ##\nover_voltage=6\narm_freq=2000\n")),(0,o.kt)("p",null,"use ",(0,o.kt)("inlineCode",{parentName:"p"},"CTRL + x")," to save and ",(0,o.kt)("inlineCode",{parentName:"p"},"y")," to confirm and exit."),(0,o.kt)("p",null,"Save and reboot."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"sudo reboot\n")),(0,o.kt)("h3",{id:"configure-raspbian"},"Configure Raspbian"),(0,o.kt)("h4",{id:"disable-the-root-user"},"Disable the root user"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"sudo passwd -l root\n")),(0,o.kt)("h4",{id:"secure-shared-memory"},"Secure shared memory"),(0,o.kt)("p",null,"Mount shared memory as read only. Open /etc/fstab."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"sudo nano /etc/fstab\n")),(0,o.kt)("p",null,"Add this line at the bottom, save & exit."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="/etc/fstab"',title:'"/etc/fstab"'},"tmpfs    /run/shm    tmpfs    ro,noexec,nosuid    0 0\n")),(0,o.kt)("h4",{id:"increase-open-file-limit-for-user"},"Increase open file limit for $USER"),(0,o.kt)("p",null,"Add a couple lines to the bottom of /etc/security/limits.conf"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo bash -c \"echo -e '${USER} soft nofile 800000\\n${USER} hard nofile 1048576\\n' >> /etc/security/limits.conf\"\n")),(0,o.kt)("p",null,"Confirm it was added to the bottom."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"cat /etc/security/limits.conf\n")),(0,o.kt)("h4",{id:"optimize-performance--security"},"Optimize performance & security"),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("a",{parentName:"p",href:"https://gist.github.com/lokhman/cc716d2e2d373dd696b2d9264c0287a3"},"https://gist.github.com/lokhman/cc716d2e2d373dd696b2d9264c0287a3"))),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"If you would like to disable ipv6 or turn on forwarding you can below.")),(0,o.kt)("p",null,"Add the following to the bottom of /etc/sysctl.conf. Save and exit."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo nano /etc/sysctl.conf\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="/etc/sysctl.conf"',title:'"/etc/sysctl.conf"'},"## Pi Node ##\n\nfs.file-max = 10000000\nfs.nr_open = 10000000\n\n# enable forwarding if using wireguard\nnet.ipv4.ip_forward=0\n\n# ignore ICMP redirects\nnet.ipv4.conf.all.send_redirects = 0\nnet.ipv4.conf.default.send_redirects = 0\nnet.ipv4.conf.all.accept_redirects = 0\nnet.ipv4.conf.default.accept_redirects = 0\n\nnet.ipv4.icmp_ignore_bogus_error_responses = 1\n\n# disable IPv6\n#net.ipv6.conf.all.disable_ipv6 = 1\n#net.ipv6.conf.default.disable_ipv6 = 1\n\n# block SYN attacks\nnet.ipv4.tcp_syncookies = 1\nnet.ipv4.tcp_max_syn_backlog = 2048\nnet.ipv4.tcp_synack_retries = 3\nnet.ipv4.netfilter.ip_conntrack_tcp_timeout_syn_recv=45\n\n# in progress tasks\nnet.ipv4.tcp_keepalive_time = 240\nnet.ipv4.tcp_keepalive_intvl = 4\nnet.ipv4.tcp_keepalive_probes = 5\n\n# reboot if we run out of memory\nvm.panic_on_oom = 1\nkernel.panic = 10\n\n# Use Google's congestion control algorithm\nnet.core.default_qdisc = fq\nnet.ipv4.tcp_congestion_control = bbr\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Load our changes after boot")),(0,o.kt)("p",null,"Create a new file. Paste, save & close."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"sudo nano /etc/rc.local\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="/etc/rc.local"',title:'"/etc/rc.local"'},'#\n# rc.local\n#\n# This script is executed at the end of each multiuser runlevel.\n# Make sure that the script will "exit 0" on success or any other\n# value on error.\n#\n# In order to enable or disable this script just change the execution\n# bits.\n#\n# By default this script does nothing.\n\n# Print the IP address\n_IP=$(hostname -I) || true\nif [ "$_IP" ]; then\n  printf "My IP address is %s\\n" "$_IP"\nfi\n# Give CPU startup routines time to settle.\nsleep 120\n\nsysctl -p /etc/sysctl.conf\n\nexit 0\n')),(0,o.kt)("h4",{id:"chrony"},"Chrony"),(0,o.kt)("p",null,"We need to get our time synchronization as accurate as possible. Open /etc/chrony/chrony.conf"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"sudo apt install chrony\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo nano /etc/chrony/chrony.conf\n")),(0,o.kt)("p",null,"Replace the contents of the file with below, Save and exit."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="/etc/chrony/chrony.conf"',title:'"/etc/chrony/chrony.conf"'},"pool time.google.com       iburst minpoll 2 maxpoll 2 maxsources 3 maxdelay 0.3\npool time.euro.apple.com   iburst minpoll 2 maxpoll 2 maxsources 3 maxdelay 0.3\npool time.apple.com        iburst minpoll 2 maxpoll 2 maxsources 3 maxdelay 0.3\npool ntp.ubuntu.com        iburst minpoll 2 maxpoll 2 maxsources 3 maxdelay 0.3\n\n# This directive specify the location of the file containing ID/key pairs for\n# NTP authentication.\nkeyfile /etc/chrony/chrony.keys\n\n# This directive specify the file into which chronyd will store the rate\n# information.\ndriftfile /var/lib/chrony/chrony.drift\n\n# Uncomment the following line to turn logging on.\n#log tracking measurements statistics\n\n# Log files location.\nlogdir /var/log/chrony\n\n# Stop bad estimates upsetting machine clock.\nmaxupdateskew 5.0\n\n# This directive enables kernel synchronisation (every 11 minutes) of the\n# real-time clock. Note that it can\u2019t be used along with the 'rtcfile' directive.\nrtcsync\n\n# Step the system clock instead of slewing it if the adjustment is larger than\n# one second, but only in the first three clock updates.\nmakestep 0.1 -1\n\n# Get TAI-UTC offset and leap seconds from the system tz database\nleapsectz right/UTC\n\n# Serve time even if not synchronized to a time source.\nlocal stratum 10\n")),(0,o.kt)("p",null,"Save & exit."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo service chrony restart\n")),(0,o.kt)("h4",{id:"zram-swap"},"Zram swap"),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"We have found that cardano-node can safely use this compressed swap in ram essentially giving us around 20gb of ram. We already set kernel parameters for zram in /etc/sysctl.conf")),(0,o.kt)("p",null,"Swapping to disk is slow, swapping to compressed ram space is faster and gives us some overhead before out of memory (oom)."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://haydenjames.io/raspberry-pi-performance-add-zram-kernel-parameters/"},"RPi OS ZRAM Guide")),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://lists.ubuntu.com/archives/lubuntu-users/2013-October/005831.html"},"Ubunutu Article on ZRAM")),(0,o.kt)("p",null,"Disable Raspbian swapfile."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"sudo systemctl disable dphys-swapfile.service\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"sudo apt install zram-tools\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo nano /etc/default/zramswap\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="/etc/default/zramswap"',title:'"/etc/default/zramswap"'},"# Compression algorithm selection\n# speed: lz4 > zstd > lzo\n# compression: zstd > lzo > lz4\n# This is not inclusive of all that is available in latest kernels\n# See /sys/block/zram0/comp_algorithm (when zram module is loaded) to see\n# what is currently set and available for your kernel[1]\n# [1]  https://github.com/torvalds/linux/blob/master/Documentation/blockdev/zram.txt#L86\n#ALGO=lz4\n\n# Specifies the amount of RAM that should be used for zram\n# based on a percentage the total amount of available memory\n# This takes precedence and overrides SIZE below\nPERCENT=150\n\n# Specifies a static amount of RAM that should be used for\n# the ZRAM devices, this is in MiB\n#SIZE=256\n\n# Specifies the priority for the swap devices, see swapon(2)\n# for more details. Higher number = higher priority\n# This should probably be higher than hdd/ssd swaps.\n#PRIORITY=100\n")),(0,o.kt)("p",null,"Save and reboot."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo reboot\n")),(0,o.kt)("h3",{id:"install-packages"},"Install packages"),(0,o.kt)("p",null,"Install the packages we will need."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo apt install build-essential libssl-dev tcptraceroute python3-pip \\\n         make automake unzip net-tools nginx ssl-cert pkg-config jq \\\n         libffi-dev libgmp-dev libssl-dev libtinfo-dev libsystemd-dev \\\n         zlib1g-dev g++ libncursesw5 libtool autoconf unattended-upgrades -y\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"sudo reboot\n")),(0,o.kt)("h3",{id:"automatic-security-updates"},"Automatic security updates"),(0,o.kt)("p",null,"Enable automatic security updates."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo dpkg-reconfigure -plow unattended-upgrades\n")),(0,o.kt)("h2",{id:"environment-setup"},"Environment Setup"),(0,o.kt)("hr",null),(0,o.kt)("h3",{id:"description-configure-the-environment-for-cardano-node"},"description: Configure the environment for Cardano Node"),(0,o.kt)("h3",{id:"choose-testnet-or-mainnet"},"Choose testnet or mainnet."),(0,o.kt)("admonition",{type:"danger"},(0,o.kt)("p",{parentName:"admonition"},"There is a 500 \u20b3 Registration deposit and another 5 \u20b3 in registration costs to start a pool on mainnet. First time users are strongly reccomended to use testnet. You can get tada (test ada) from the testnet faucet. ",(0,o.kt)("a",{parentName:"p",href:"https://testnets.cardano.org/en/testnets/cardano/tools/faucet/"},"tada faucet link"))),(0,o.kt)("p",null,"Create the directories for our project."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"mkdir -p ${HOME}/.local/bin\nmkdir -p ${HOME}/pi-pool/files\nmkdir -p ${HOME}/pi-pool/scripts\nmkdir -p ${HOME}/pi-pool/logs\nmkdir ${HOME}/git\nmkdir ${HOME}/tmp\n")),(0,o.kt)("p",null,"Create an .adaenv file, choose which network you want to be on and source the file. This file will hold the variables/settings for operating a Pi-Node. /home/ada/.adaenv"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"echo -e NODE_CONFIG=testnet >> ${HOME}/.adaenv; source ${HOME}/.adaenv\n")),(0,o.kt)("h4",{id:"create-bash-variables--add-localbin-to-our-path-"},"Create bash variables & add ","~","/.local/bin to our $PATH \ud83c\udfc3"),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("a",{parentName:"p",href:"https://askubuntu.com/questions/247738/why-is-etc-profile-not-invoked-for-non-login-shells/247769#247769"},"Environment Variables in Linux/Unix"),".")),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"You must reload environment files after updating them. Same goes for cardano-node, changes to the topology or config files require a cardano-service restart.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"echo . ~/.adaenv >> ${HOME}/.bashrc\ncd .local/bin; echo \"export PATH=\\\"$PWD:\\$PATH\\\"\" >> $HOME/.adaenv\necho export NODE_HOME=${HOME}/pi-pool >> ${HOME}/.adaenv\necho export NODE_PORT=3003 >> ${HOME}/.adaenv\necho export NODE_FILES=${HOME}/pi-pool/files >> ${HOME}/.adaenv\necho export TOPOLOGY='${NODE_FILES}'/'${NODE_CONFIG}'-topology.json >> ${HOME}/.adaenv\necho export DB_PATH='${NODE_HOME}'/db >> ${HOME}/.adaenv\necho export CONFIG='${NODE_FILES}'/'${NODE_CONFIG}'-config.json >> ${HOME}/.adaenv\necho export NODE_BUILD_NUM=$(curl https://hydra.iohk.io/job/Cardano/iohk-nix/cardano-deployment/latest-finished/download/1/index.html | grep -e \"build\" | sed 's/.*build\\/\\([0-9]*\\)\\/download.*/\\1/g') >> ${HOME}/.adaenv\necho export CARDANO_NODE_SOCKET_PATH=\"${HOME}/pi-pool/db/socket\" >> ${HOME}/.adaenv\nsource ${HOME}/.bashrc; source ${HOME}/.adaenv\n")),(0,o.kt)("h3",{id:"build-libsodium"},"Build Libsodium"),(0,o.kt)("p",null,"This is IOHK's fork of Libsodium. It is needed for the dynamic build binary of cardano-node."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"cd; cd git/\ngit clone https://github.com/input-output-hk/libsodium\ncd libsodium\ngit checkout 66f017f1\n./autogen.sh\n./configure\nmake\nsudo make install\n")),(0,o.kt)("p",null,"Echo library paths .bashrc file and source it."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},'echo "export LD_LIBRARY_PATH="/usr/local/lib:$LD_LIBRARY_PATH"" >> ~/.bashrc\necho "export PKG_CONFIG_PATH="/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH"" >> ~/.bashrc\n. ~/.bashrc\n')),(0,o.kt)("p",null,"Update link cache for shared libraries and confirm."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo ldconfig; ldconfig -p | grep libsodium\n")),(0,o.kt)("h4",{id:"retrieve-node-files"},"Retrieve node files"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"cd $NODE_FILES\nwget -N https://hydra.iohk.io/build/${NODE_BUILD_NUM}/download/1/${NODE_CONFIG}-config.json\nwget -N https://hydra.iohk.io/build/${NODE_BUILD_NUM}/download/1/${NODE_CONFIG}-byron-genesis.json\nwget -N https://hydra.iohk.io/build/${NODE_BUILD_NUM}/download/1/${NODE_CONFIG}-shelley-genesis.json\nwget -N https://hydra.iohk.io/build/${NODE_BUILD_NUM}/download/1/${NODE_CONFIG}-alonzo-genesis.json\nwget -N https://hydra.iohk.io/build/${NODE_BUILD_NUM}/download/1/${NODE_CONFIG}-topology.json\nwget -N https://raw.githubusercontent.com/input-output-hk/cardano-node/master/cardano-submit-api/config/tx-submit-mainnet-config.yaml\n")),(0,o.kt)("p",null,"Run the following to modify ${NODE","_",'CONFIG}-config.json and update TraceBlockFetchDecisions to "true" & listen on all interfaces with Prometheus Node Exporter.'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},'sed -i ${NODE_CONFIG}-config.json \\\n    -e "s/TraceBlockFetchDecisions\\": false/TraceBlockFetchDecisions\\": true/g" \\\n    -e "s/127.0.0.1/0.0.0.0/g"\n')),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("strong",{parentName:"p"},"Tip for relay nodes"),': It\'s possible to reduce memory and cpu usage by setting "TraceMemPool" to "false" in ',(0,o.kt)("strong",{parentName:"p"},"{NODE","_","CONFIG}-config.json.")," This will turn off mempool data in Grafana and gLiveView.sh.")),(0,o.kt)("h4",{id:"retrieve-aarch64-1331-and-cardano-submit-api-binaries"},"Retrieve aarch64 1.33.1 and cardano-submit-api binaries"),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"The ",(0,o.kt)("strong",{parentName:"p"},"unofficial")," cardano-node, cardano-cli and cardano-submit-api binaries available to us are being built by an IOHK engineer in his ",(0,o.kt)("strong",{parentName:"p"},"spare time"),". Consider delegating to zw3rk pool to support mobile Haskel development.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"cd ${HOME}/tmp\nwget https://ci.zw3rk.com/build/430108/download/1/aarch64-unknown-linux-musl-cardano-node-1.33.1.zip\nunzip *.zip\nmv cardano-node/cardano-* ${HOME}/.local/bin\nrm -r *\ncd ${HOME}\n")),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"If binaries already exist (if updating) you will have to confirm overwriting the old ones.")),(0,o.kt)("p",null,"Confirm binaries are in $USER's $PATH."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"cardano-node version\ncardano-cli version\nwhich cardano-submit-api\n")),(0,o.kt)("h4",{id:"systemd-unit-startup-scripts"},"Systemd unit startup scripts"),(0,o.kt)("p",null,"Create the systemd unit file and startup script so systemd can manage cardano-node."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"nano ${HOME}/.local/bin/cardano-service\n")),(0,o.kt)("p",null,"Paste the following, save & exit."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="${HOME}/.local/bin/cardano-service"',title:'"${HOME}/.local/bin/cardano-service"'},"#!/bin/bash\n. /home/ada/.adaenv\n\n## +RTS -N4 -RTS = Multicore(4)\ncardano-node run +RTS -N4 -RTS \\\n  --topology ${TOPOLOGY} \\\n  --database-path ${DB_PATH} \\\n  --socket-path ${CARDANO_NODE_SOCKET_PATH} \\\n  --port ${NODE_PORT} \\\n  --config ${CONFIG}\n")),(0,o.kt)("p",null,"Allow execution of our new cardano-node service file."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"chmod +x ${HOME}/.local/bin/cardano-service\n")),(0,o.kt)("p",null,"Open /etc/systemd/system/cardano-node.service."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo nano /etc/systemd/system/cardano-node.service\n")),(0,o.kt)("p",null,"Paste the following, You will need to edit the username here if you chose to not use ada. Save & exit."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="/etc/systemd/system/cardano-node.service"',title:'"/etc/systemd/system/cardano-node.service"'},'# The Cardano Node Service (part of systemd)\n# file: /etc/systemd/system/cardano-node.service\n\n[Unit]\nDescription     = Cardano node service\nWants           = network-online.target\nAfter           = network-online.target\n\n[Service]\nUser            = ada\nType            = simple\nWorkingDirectory= /home/ada/pi-pool\nExecStart       = /bin/bash -c "PATH=/home/ada/.local/bin:$PATH exec /home/ada/.local/bin/cardano-service"\nKillSignal=SIGINT\nRestartKillSignal=SIGINT\nTimeoutStopSec=10\nLimitNOFILE=32768\nRestart=always\nRestartSec=10\nEnvironmentFile=-/home/ada/.adaenv\n\n[Install]\nWantedBy= multi-user.target\n')),(0,o.kt)("p",null,"Create the systemd unit file and startup script so systemd can manage cardano-submit-api."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"nano ${HOME}/.local/bin/cardano-submit-service\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="${HOME}/.local/bin/cardano-submit-service"',title:'"${HOME}/.local/bin/cardano-submit-service"'},"#!/bin/bash\n. /home/ada/.adaenv\n\ncardano-submit-api \\\n  --socket-path ${CARDANO_NODE_SOCKET_PATH} \\\n  --port 8090 \\\n  --config /home/ada/pi-pool/files/tx-submit-mainnet-config.yaml \\\n  --listen-address 0.0.0.0 \\\n  --mainnet\n")),(0,o.kt)("p",null,"Allow execution of our new cardano-submit-api service script."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"chmod +x ${HOME}/.local/bin/cardano-submit-service\n")),(0,o.kt)("p",null,"Create /etc/systemd/system/cardano-submit.service."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo nano /etc/systemd/system/cardano-submit.service\n")),(0,o.kt)("p",null,"Paste the following, You will need to edit the username here if you chose to not use ada. save & exit."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},'# The Cardano Submit Service (part of systemd)\n# file: /etc/systemd/system/cardano-submit.service\n\n[Unit]\nDescription     = Cardano submit service\nWants           = network-online.target\nAfter           = network-online.target\n\n[Service]\nUser            = ada\nType            = simple\nWorkingDirectory= /home/ada/pi-pool\nExecStart       = /bin/bash -c "PATH=/home/ada/.local/bin:$PATH exec /home/ada/.local/bin/cardano-submit-service"\nKillSignal=SIGINT\nRestartKillSignal=SIGINT\nTimeoutStopSec=10\nLimitNOFILE=32768\nRestart=always\nRestartSec=10\nEnvironmentFile=-/home/ada/.adaenv\n\n[Install]\nWantedBy= multi-user.target\n')),(0,o.kt)("p",null,"Reload systemd so it picks up our new service files."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo systemctl daemon-reload\n")),(0,o.kt)("p",null,"Let's add a couple functions to the bottom of our .adaenv file to make life a little easier."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"nano ${HOME}/.adaenv\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="${HOME}/.adaenv"',title:'"${HOME}/.adaenv"'},'cardano-service() {\n    #do things with parameters like $1 such as\n    sudo systemctl "$1" cardano-node.service\n}\n\ncardano-submit() {\n    #do things with parameters like $1 such as\n    sudo systemctl "$1" cardano-submit.service\n}\n')),(0,o.kt)("p",null,"Save & exit."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"source ${HOME}/.adaenv\n")),(0,o.kt)("p",null,"What we just did there was add a couple functions to control our cardano-service and cardano-submit without having to type out"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"sudo systemctl enable cardano-node.service")),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"sudo systemctl start cardano-node.service")),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"sudo systemctl stop cardano-node.service")),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"sudo systemctl status cardano-node.service")),(0,o.kt)("p",null,"Now we just have to:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"cardano-service enable (enables cardano-node.service auto start at boot)"),(0,o.kt)("li",{parentName:"ul"},"cardano-service start (starts cardano-node.service)"),(0,o.kt)("li",{parentName:"ul"},"cardano-service stop (stops cardano-node.service)"),(0,o.kt)("li",{parentName:"ul"},"cardano-service status (shows the status of cardano-node.service)")),(0,o.kt)("p",null,"Or"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"cardano-submit enable (enables cardano-submit.service auto start at boot)"),(0,o.kt)("li",{parentName:"ul"},"cardano-submit start (starts cardano-submit.service)"),(0,o.kt)("li",{parentName:"ul"},"cardano-submit stop (stops cardano-submit.service)"),(0,o.kt)("li",{parentName:"ul"},"cardano-submit status (shows the status of cardano-submit.service)")),(0,o.kt)("p",null,"The submit service listens on port 8090. You can connect your Nami wallet like below to submit tx's yourself in Nami's settings."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"http://<node lan ip>:8090/api/submit/tx\n")),(0,o.kt)("h3",{id:"-syncing-the-chain-"},"\u26d3 Syncing the chain \u26d3"),(0,o.kt)("p",null,"You are now ready to start cardano-node. Doing so will start the process of 'syncing the chain'. This is going to take about 48 hours and the db folder is about 13GB in size right now. We used to have to sync it to one node and copy it from that node to our new ones to save time. However..."),(0,o.kt)("h4",{id:"download-snapshot"},"Download snapshot"),(0,o.kt)("p",null,"I have started taking snapshots of my backup nodes db folder and hosting it in a web directory. With this service it takes around 20 minutes to pull the latest snapshot and maybe another hour to sync up to the tip of the chain. This service is provided as is. It is up to you. If you want to sync the chain on your own simply:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"cardano-service enable\ncardano-service start\ncardano-service status\n")),(0,o.kt)("p",null,"Otherwise, be sure your node is ",(0,o.kt)("strong",{parentName:"p"},"not")," running & delete the db folder if it exists and download db/."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"cardano-service stop\ncd $NODE_HOME\nrm -r db/\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Download Database")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},'wget -r -np -nH -R "index.html*" -e robots=off https://$NODE_CONFIG.adamantium.online/db/\n')),(0,o.kt)("p",null,"Once wget completes enable & start cardano-node."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"cardano-service enable\ncardano-service start\ncardano-service status\n")),(0,o.kt)("h3",{id:"gliveviewsh"},"gLiveView.sh"),(0,o.kt)("p",null,"Guild operators scripts has a couple useful tools for operating a pool. We do not want the project as a whole, though there are a couple scripts we are going to use."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/cardano-community/guild-operators/tree/master/scripts/cnode-helper-scripts"},"Guild Operators Helper Scripts")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"cd $NODE_HOME/scripts\nwget https://raw.githubusercontent.com/cardano-community/guild-operators/master/scripts/cnode-helper-scripts/env\nwget https://raw.githubusercontent.com/cardano-community/guild-operators/master/scripts/cnode-helper-scripts/gLiveView.sh\n")),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"You can change the port cardano-node runs on in the .adaenv file in your home directory. Open the file edit the port number. Load the change into your shell & restart the cardano-node service."),(0,o.kt)("pre",{parentName:"admonition"},(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"nano /home/ada/.adaenv\nsource /home/ada/.adaenv\ncardano-service restart\n"))),(0,o.kt)("p",null,"Add a line sourcing our .adaenv file to the top of the env file and adjust some paths."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},'sed -i env \\\n    -e "/#CNODEBIN/i. ${HOME}/.adaenv" \\\n    -e "s/\\#CNODE_HOME=\\"\\/opt\\/cardano\\/cnode\\"/CNODE_HOME=\\"\\${HOME}\\/pi-pool\\"/g" \\\n    -e "s/\\#CNODE_PORT=6000"/CNODE_PORT=\\"\'${NODE_PORT}\'\\""/g" \\\n    -e "s/\\#CONFIG=\\"\\${CNODE_HOME}\\/files\\/config.json\\"/CONFIG=\\"\\${NODE_FILES}\\/"\'${NODE_CONFIG}\'"-config.json\\"/g" \\\n    -e "s/\\#TOPOLOGY=\\"\\${CNODE_HOME}\\/files\\/topology.json\\"/TOPOLOGY=\\"\\${NODE_FILES}\\/"\'${NODE_CONFIG}\'"-topology.json\\"/g" \\\n    -e "s/\\#LOG_DIR=\\"\\${CNODE_HOME}\\/logs\\"/LOG_DIR=\\"\\${CNODE_HOME}\\/logs\\"/g"\n')),(0,o.kt)("p",null,"Allow execution of gLiveView.sh."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"chmod +x gLiveView.sh\n")),(0,o.kt)("h3",{id:"topologyupdatersh"},"topologyUpdater.sh"),(0,o.kt)("p",null,"Until peer to peer is enabled on the network operators need a way to get a list of relays/peers to connect to. The topology updater service runs in the background with cron. Every hour the script will run and tell the service you are a relay and want to be a part of the network. It will add your relay to it's directory after four hours you should see in connections in gLiveView."),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"The list generated will show you the distance & a clue as to where the relay is located.")),(0,o.kt)("p",null,"Download the topologyUpdater script and have a look at it. Lower the number of peers to 10 and add any custom peers you wish. These are outgoing connections. You will not see any incoming transactions untill other nodes start connecting to you."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"wget https://raw.githubusercontent.com/cardano-community/guild-operators/master/scripts/cnode-helper-scripts/topologyUpdater.sh\n")),(0,o.kt)("p",null,"Lower the number of MX","_","PEERS to 10."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"nano topologyUpdater.sh\n")),(0,o.kt)("p",null,"Save, exit and make it executable."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"chmod +x topologyUpdater.sh\n")),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"You will not be able to successfully execute ./topologyUpdater.sh until you are fully synced up to the tip of the chain.")),(0,o.kt)("p",null,"Create a cron job that will run the script every hour."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"crontab -e\n")),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"Choose nano when prompted for editor.")),(0,o.kt)("p",null,"Add the following to the bottom, save & exit."),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"The Pi-Node image has this cron entry disabled by default. You can enable it by removing the #.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"SHELL=/bin/bash\nPATH=/home/ada/.local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin\n33 * * * * . $HOME/.adaenv; $HOME/pi-pool/scripts/topologyUpdater.sh\n")),(0,o.kt)("p",null,"After four hours you can open ${NODE","_","CONFIG}-topology.json and inspect the list of out peers the service suggested for you. Remove anything more than 7k distance(or less). IOHK recently suggested 8 out peers. The more out peers the more system resources it uses. You can also add any peers you wish to connect to manualy inside the script. This is where you would add your block producer or any friends nodes."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"nano $NODE_FILES/${NODE_CONFIG}-topology.json\n")),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"You can use gLiveView.sh to view ping times in relation to the peers in your {NODE","_","CONFIG}-topology file. Use Ping to resolve hostnames to IP's.")),(0,o.kt)("p",null,"Changes to this file will take affect upon restarting the cardano-service."),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"Don't forget to remove the last comma in your topology file!")),(0,o.kt)("p",null,"Status should show as enabled & running."),(0,o.kt)("p",null,"Once your node syncs past epoch 208(shelley era) you can use gLiveView.sh to monitor your sync progress."),(0,o.kt)("admonition",{type:"danger"},(0,o.kt)("p",{parentName:"admonition"},"It can take over an hour for cardano-node to sync to the tip of the chain. Use ./gliveView.sh, htop and log outputs to view process. Be patient it will come up.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"cd $NODE_HOME/scripts\n./gLiveView.sh\n")),(0,o.kt)("p",null,(0,o.kt)("img",{src:a(7431).Z,width:"463",height:"285"})),(0,o.kt)("h3",{id:"prometheus-node-exporter--grafana"},"Prometheus, Node Exporter & Grafana"),(0,o.kt)("p",null,"Prometheus connects to cardano-nodes backend and serves metrics over http. Grafana in turn can use that data to display graphs and create alerts. Our Grafana dashboard will be made up of data from our Ubuntu system & cardano-node. Grafana can display data from other sources as well, like ",(0,o.kt)("a",{parentName:"p",href:"https://adapools.org"},"adapools.org"),"."),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"You can connect a ",(0,o.kt)("a",{parentName:"p",href:"https://docs.armada-alliance.com/learn/intermediate-guide/grafana-alerts-with-telegram"},"Telegram bot")," to Grafana which can alert you of problems with the server. Much easier than trying to configure email alerts.")),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/prometheus"},"Prometheus Github")),(0,o.kt)("p",null,(0,o.kt)("img",{src:a(2383).Z,width:"1907",height:"980"})),(0,o.kt)("h4",{id:"install-prometheus--node-exporter"},"Install Prometheus & Node Exporter."),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"Prometheus can scrape the http endpoints of other servers running node exporter. Meaning Grafana and Prometheus does not have to be installed on your core and relays. Only the package prometheus-node-exporter is required if you would like to build a central Grafana dashboard for the pool, freeing up resources and having a single dashboard to monitor everything.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo apt install prometheus prometheus-node-exporter -y\n")),(0,o.kt)("p",null,"Disable them in systemd for now."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo systemctl disable prometheus.service\nsudo systemctl disable prometheus-node-exporter.service\n")),(0,o.kt)("h4",{id:"configure-prometheus"},"Configure Prometheus"),(0,o.kt)("p",null,"Open prometheus.yml."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo nano /etc/prometheus/prometheus.yml\n")),(0,o.kt)("p",null,"Replace the contents of the file with."),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"Indentation must be correct YAML format or Prometheus will fail to start.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="/etc/prometheus/prometheus.yml"',title:'"/etc/prometheus/prometheus.yml"'},"global:\n  scrape_interval: 15s # By default, scrape targets every 15 seconds.\n\n  # Attach these labels to any time series or alerts when communicating with\n  # external systems (federation, remote storage, Alertmanager).\n  external_labels:\n    monitor: \"codelab-monitor\"\n\n# A scrape configuration containing exactly one endpoint to scrape:\n# Here it's Prometheus itself.\nscrape_configs:\n  # The job name is added as a label job=<job_name> to any timeseries scraped from this config.\n  - job_name: \"Prometheus\" # To scrape data from Prometheus Node Exporter\n    scrape_interval: 5s\n    static_configs:\n      #      - targets: ['<CORE PRIVATE IP>:12798']\n      #        labels:\n      #          alias: 'C1'\n      #          type:  'cardano-node'\n      #      - targets: ['<RELAY PRIVATE IP>:12798']\n      #        labels:\n      #          alias: 'R1'\n      #          type:  'cardano-node'\n      - targets: [\"localhost:12798\"]\n        labels:\n          alias: \"N1\"\n          type: \"cardano-node\"\n\n      #      - targets: ['<CORE PRIVATE IP>:9100']\n      #        labels:\n      #          alias: 'C1'\n      #          type:  'node'\n      #      - targets: ['<RELAY PRIVATE IP>:9100']\n      #        labels:\n      #          alias: 'R1'\n      #          type:  'node'\n      - targets: [\"localhost:9100\"]\n        labels:\n          alias: \"N1\"\n          type: \"node\"\n")),(0,o.kt)("p",null,"Save & exit."),(0,o.kt)("p",null,"Start Prometheus."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo systemctl start prometheus.service\n")),(0,o.kt)("h4",{id:"install-grafana"},"Install Grafana"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/grafana/grafana"},"Grafana GitHub")),(0,o.kt)("p",null,"Add Grafana's gpg key to Ubuntu."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add -\n")),(0,o.kt)("p",null,"Add latest stable repo to apt sources."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},'echo "deb https://packages.grafana.com/oss/deb stable main" | sudo tee -a /etc/apt/sources.list.d/grafana.list\n')),(0,o.kt)("p",null,"Update your package lists & install Grafana."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo apt update; sudo apt install grafana\n")),(0,o.kt)("p",null,"Change the port Grafana listens on so it does not clash with cardano-node."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},'sudo sed -i /etc/grafana/grafana.ini \\\n         -e "s#;http_port#http_port#" \\\n         -e "s#3000#5000#"\n')),(0,o.kt)("p",null,"Start Grafana"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo systemctl start grafana-server.service\n")),(0,o.kt)("h4",{id:"cardano-monitor-bash-function"},"cardano-monitor bash function"),(0,o.kt)("p",null,"Open .adaenv."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"cd ${HOME}; nano .adaenv\n")),(0,o.kt)("p",null,"Down at the bottom add."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="${HOME}/.adaenv"',title:'"${HOME}/.adaenv"'},'cardano-monitor() {\n    #do things with parameters like $1 such as\n    sudo systemctl "$1" prometheus.service\n    sudo systemctl "$1" prometheus-node-exporter.service\n    sudo systemctl "$1" grafana-server.service\n}\n')),(0,o.kt)("p",null,"Save, exit & source."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"source .adaenv\n")),(0,o.kt)("p",null,"Here we tied all three services under one function. Enable Prometheus.service, prometheus-node-exporter.service & grafana-server.service to run on boot and start the services."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"cardano-monitor enable\ncardano-monitor start\n")),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"At this point you may want to start cardano-service and get synced up before we continue to configure Grafana. Go to the syncing the chain section. Choose whether you want to wait 30 hours or download the latest chain snapshot. Return here once gLiveView.sh shows you are at the tip of the chain.")),(0,o.kt)("h3",{id:"grafana-nginx-proxy_pass--snakeoil"},"Grafana, Nginx proxy","_","pass & snakeoil"),(0,o.kt)("p",null,"Let's put Grafana behind Nginx with self signed(snakeoil) certificate. The certificate was generated when we installed the ssl-cert package."),(0,o.kt)("p",null,"You will get a warning from your browser. This is because ca-certificates cannot follow a trust chain to a trusted (centralized) source. The connection is however encrypted and will protect your passwords flying around in plain text."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo nano /etc/nginx/sites-available/default\n")),(0,o.kt)("p",null,"Replace contents of the file with below."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="/etc/nginx/sites-available/default"',title:'"/etc/nginx/sites-available/default"'},"# Default server configuration\n#\nserver {\n        listen 80 default_server;\n        return 301 https://$host$request_uri;\n}\n\nserver {\n        # SSL configuration\n        #\n        listen 443 ssl default_server;\n        #listen [::]:443 ssl default_server;\n        #\n        # Note: You should disable gzip for SSL traffic.\n        # See: https://bugs.debian.org/773332\n        #\n        # Read up on ssl_ciphers to ensure a secure configuration.\n        # See: https://bugs.debian.org/765782\n        #\n        # Self signed certs generated by the ssl-cert package\n        # Don't use them in a production server!\n        #\n        include snippets/snakeoil.conf;\n\n        add_header X-Proxy-Cache $upstream_cache_status;\n        location / {\n          proxy_pass http://127.0.0.1:5000;\n          proxy_redirect      off;\n          include proxy_params;\n        }\n}\n")),(0,o.kt)("p",null,"Check that Nginx is happy with our changes and restart it."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo nginx -t\n## if ok, do\nsudo service nginx restart\n")),(0,o.kt)("p",null,"You can now visit your pi-nodes ip address without any port specification, the connection will be upgraded to SSL/TLS and you will get a scary message(not really scary at all). Continue through to your dashboard."),(0,o.kt)("p",null,(0,o.kt)("img",{src:a(1654).Z,width:"2032",height:"1082"})),(0,o.kt)("h4",{id:"configure-grafana"},"Configure Grafana"),(0,o.kt)("p",null,"On your local machine open your browser and enter your nodes private ip address."),(0,o.kt)("p",null,"Log in and set a new password. Default username and password is ",(0,o.kt)("strong",{parentName:"p"},"admin:admin"),"."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Configure data source")),(0,o.kt)("p",null,"In the left hand vertical menu go to ",(0,o.kt)("strong",{parentName:"p"},"Configure")," > ",(0,o.kt)("strong",{parentName:"p"},"Datasources")," and click to ",(0,o.kt)("strong",{parentName:"p"},"Add data source"),". Choose Prometheus. Enter ",(0,o.kt)("a",{parentName:"p",href:"http://localhost:9090"},"http://localhost:9090"),' where it is grayed out, everything else can be left default. At the bottom save & test. You should get the green "Data source is working" if cardano-monitor has been started. If for some reason those services failed to start issue ',(0,o.kt)("strong",{parentName:"p"},"cardano-service restart"),"."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Import dashboards")),(0,o.kt)("p",null,"Save the dashboard json files to your local machine."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/armada-alliance/dashboards"},"Armada Alliance Grafana Dashboards")),(0,o.kt)("p",null,"In the left hand vertical menu go to ",(0,o.kt)("strong",{parentName:"p"},"Dashboards")," > ",(0,o.kt)("strong",{parentName:"p"},"Manage")," and click on ",(0,o.kt)("strong",{parentName:"p"},"Import"),". Select the file you just downloaded/created and save. Head back to ",(0,o.kt)("strong",{parentName:"p"},"Dashboards")," > ",(0,o.kt)("strong",{parentName:"p"},"Manage")," and click on your new dashboard."),(0,o.kt)("p",null,(0,o.kt)("img",{src:a(2383).Z,width:"1907",height:"980"})),(0,o.kt)("h4",{id:"configure-pooldatalive"},"Configure poolDataLive"),(0,o.kt)("p",null,"Here you can use the poolData api to bring extra pool data into Grafana like stake & price."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://api.pooldata.live/dashboard"},"poolData API")),(0,o.kt)("p",null,"Follow the instructions to install the Grafana plugin, configure your datasource and import the dashboard."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo grafana-cli plugins install simpod-json-datasource\ncardano-monitor restart\n")),(0,o.kt)("h3",{id:"useful-commands"},"Useful Commands"),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"View how much zram swap cardano-node is using."),(0,o.kt)("pre",{parentName:"admonition"},(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"CNZRAM=$(pidof cardano-node)\ngrep --color VmSwap /proc/$CNZRAM/status\n")),(0,o.kt)("p",{parentName:"admonition"},"Follow log output to journal."),(0,o.kt)("pre",{parentName:"admonition"},(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo journalctl --unit=cardano-node --follow\n")),(0,o.kt)("p",{parentName:"admonition"},"Follow log output to stdout."),(0,o.kt)("pre",{parentName:"admonition"},(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo tail -f /var/log/syslog\n")),(0,o.kt)("p",{parentName:"admonition"},"View network connections with netstat."),(0,o.kt)("pre",{parentName:"admonition"},(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=">_ Terminal"',title:'">_','Terminal"':!0},"sudo netstat -puntw\n"))),(0,o.kt)("p",null,"From here you have a Pi-Node with tools to build an active relay or a stake pool from the following pages. Best of luck and please join the ",(0,o.kt)("a",{parentName:"p",href:"https://armada-alliance.com"},"armada-alliance"),", together we are stronger! \ud83d\udcaa"))}c.isMDXComponent=!0},9099:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/disable-auto-login-cf67f73138f236247dad32a47b0a5d94.png"},7431:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/pi-node-glive-1e55923399447d3911e848db7c0be880.png"},2383:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/pi-pool-grafana-55cbdd28508cd62938e7317a2e234d78.png"},9008:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/pi4-usb-e07dc4e6e8002c7cd7441b3675fda13a.jpeg"},9098:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/raspberrypi-configuration-aaf3d203036c9bb06d576ac723770dd7.png"},1654:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/snakeoil-c25f574bc5765046f70d41db95d6a27b.png"},7485:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/yoda-patient-7df4556f15700e6c405a7f9ee5c53d4c.jpeg"}}]);