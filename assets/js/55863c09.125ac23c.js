"use strict";(self.webpackChunkarmada_alliance_docusaurus=self.webpackChunkarmada_alliance_docusaurus||[]).push([[2700],{7938:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>i,metadata:()=>s,toc:()=>c});var o=a(4848),t=a(8453);const i={description:"Turn Pi-Node into an active Cardano relay",keywords:["guides","cardano relay","cardano node","cardano stake pool","rasbperry pi","armada alliance","ubuntu"]},r="Pi-Relay",s={id:"stake-pool-guides/pi-pool-tutorial/pi-node-full-guide/pi-relay",title:"Pi-Relay",description:"Turn Pi-Node into an active Cardano relay",source:"@site/docs/stake-pool-guides/pi-pool-tutorial/pi-node-full-guide/pi-relay.md",sourceDirName:"stake-pool-guides/pi-pool-tutorial/pi-node-full-guide",slug:"/stake-pool-guides/pi-pool-tutorial/pi-node-full-guide/pi-relay",permalink:"/docs/stake-pool-guides/pi-pool-tutorial/pi-node-full-guide/pi-relay",draft:!1,unlisted:!1,editUrl:"https://github.com/armada-alliance/docs/edit/master/docs/stake-pool-guides/pi-pool-tutorial/pi-node-full-guide/pi-relay.md",tags:[],version:"current",frontMatter:{description:"Turn Pi-Node into an active Cardano relay",keywords:["guides","cardano relay","cardano node","cardano stake pool","rasbperry pi","armada alliance","ubuntu"]},sidebar:"tutorialSidebar",previous:{title:"Environment Setup",permalink:"/docs/stake-pool-guides/pi-pool-tutorial/pi-node-full-guide/environment-setup"},next:{title:"Pi-Core",permalink:"/docs/stake-pool-guides/pi-pool-tutorial/pi-node-full-guide/core-online"}},l={},c=[{value:"1. Configure hostname",id:"1-configure-hostname",level:2},{value:"2. Network",id:"2-network",level:2},{value:"2.1 Configure static IP",id:"21-configure-static-ip",level:3},{value:"2.2 Configure service port",id:"22-configure-service-port",level:3},{value:"2.3 Forward port on router",id:"23-forward-port-on-router",level:3},{value:"2.4 Topology Updater",id:"24-topology-updater",level:3},{value:"3. Enable cron job",id:"3-enable-cron-job",level:2},{value:"4. Wait for service on boarding (4 hours).",id:"4-wait-for-service-on-boarding-4-hours",level:2},{value:"5. Prune list of best (8) peers.",id:"5-prune-list-of-best-8-peers",level:2},{value:"6. Enable blockfetch tracing",id:"6-enable-blockfetch-tracing",level:2},{value:"7. Edit the alias name for Prometheus",id:"7-edit-the-alias-name-for-prometheus",level:2},{value:"8. Reboot",id:"8-reboot",level:2}];function d(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",mdxAdmonitionTitle:"mdxAdmonitionTitle",p:"p",pre:"pre",strong:"strong",...(0,t.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h1,{id:"pi-relay",children:"Pi-Relay"}),"\n",(0,o.jsx)(n.p,{children:"To turn Pi-Node into an active relay we have to follow the following steps:"}),"\n",(0,o.jsx)(n.h2,{id:"1-configure-hostname",children:"1. Configure hostname"}),"\n",(0,o.jsx)(n.p,{children:"To set a fully qualified domain name (FQDN) for our relay edit /etc/hostname & /etc/hosts."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"sudo nano /etc/hostname\n"})}),"\n",(0,o.jsx)(n.p,{children:"Replace ubuntu with your desired FQDN."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"r1.example.com\n"})}),"\n",(0,o.jsx)(n.p,{children:"Save and exit."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"sudo nano /etc/hosts\n"})}),"\n",(0,o.jsx)(n.p,{children:"Edit the file accordingly, take note that you may not be using the 192.168.1.xxx IP range."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",metastring:'title="/etc/hosts"',children:"127.0.0.1 localhost\n127.0.1.1 r1.example.com r1\n\n# The following lines are desirable for IPv6 capable hosts\n::1 ip6-localhost ip6-loopback\nfe00::0 ip6-localnet\nff00::0 ip6-mcastprefix\nff02::1 ip6-allnodes\nff02::2 ip6-allrouters\nff02::3 ip6-allhosts\n\n"})}),"\n",(0,o.jsx)(n.p,{children:"Save and exit."}),"\n",(0,o.jsx)(n.h2,{id:"2-network",children:"2. Network"}),"\n",(0,o.jsx)(n.h3,{id:"21-configure-static-ip",children:"2.1 Configure static IP"}),"\n",(0,o.jsxs)(n.p,{children:["Open ",(0,o.jsx)(n.strong,{children:"50-cloud-init.yaml"})," and replace the contents of the file with below."]}),"\n",(0,o.jsx)(n.admonition,{title:"Netplan configuration examples",type:"tip",children:(0,o.jsx)(n.p,{children:(0,o.jsx)(n.a,{href:"https://netplan.io/examples/",children:"Netplan configuration examples"})})}),"\n",(0,o.jsx)(n.admonition,{type:"caution",children:(0,o.jsxs)(n.p,{children:["Be sure to use an address on your LAN subnet. In this example I am using ",(0,o.jsx)(n.strong,{children:"192.168.1.xxx"}),". Your network may very well be using a different private range."]})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"sudo nano /etc/netplan/50-cloud-init.yaml\n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",metastring:'title="/etc/netplan/50-cloud-init.yaml"',children:"# This file is generated from information provided by the datasource.  Changes\n# to it will not persist across an instance reboot.  To disable cloud-init's\n# network configuration capabilities, write a file\n# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:\n# network: {config: disabled}\nnetwork:\n  version: 2\n  renderer: networkd\n  ethernets:\n    eth0:\n      dhcp4: no\n      addresses:\n        - 192.168.1.151/24\n      gateway4: 192.168.1.1\n      nameservers:\n# Home router IP & QUAD9 https://quad9.net/\n          addresses: [192.168.1.1, 9.9.9.9, 149.112.112.112]\n\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Create a file named ",(0,o.jsx)(n.strong,{children:"99-disable-network-config.cfg"})," to disable cloud-init."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"sudo nano /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg\n"})}),"\n",(0,o.jsx)(n.p,{children:"Add the following, save and exit."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",metastring:'title="/etc/cloud/cloud.cfg.d/99-disable-network-config.cfg"',children:"network: {config: disabled}\n"})}),"\n",(0,o.jsx)(n.p,{children:"Apply your changes."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"sudo netplan apply\n"})}),"\n",(0,o.jsx)(n.h3,{id:"22-configure-service-port",children:"2.2 Configure service port"}),"\n",(0,o.jsx)(n.p,{children:"Open the ~/.adaenv file and change the port it listens on. For R1 or my first relay I will designate port 3001."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"nano $HOME/.adaenv\n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",metastring:'title="~/.adaenv"',children:"export NODE_PORT=3001\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Save and exit. ",(0,o.jsx)(n.strong,{children:"ctrl+x then y"}),"."]}),"\n",(0,o.jsx)(n.p,{children:"Enable cardano-service at boot & restart the service to load changes."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"cardano-service enable\ncardano-service restart\n"})}),"\n",(0,o.jsx)(n.h3,{id:"23-forward-port-on-router",children:"2.3 Forward port on router"}),"\n",(0,o.jsx)(n.admonition,{type:"danger",children:(0,o.jsx)(n.p,{children:"Do not forward a port to your Core machine it only connects to your relay(s) on your LAN."})}),"\n",(0,o.jsx)(n.p,{children:"Log into your router and forward port 3001 to your relay nodes LAN IPv4 address port 3001. Second relay forward port 3002 to LAN IPv4 address for relay 2 to port 3002."}),"\n",(0,o.jsx)(n.h3,{id:"24-topology-updater",children:"2.4 Topology Updater"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"cd $NODE_HOME/scripts\n"})}),"\n",(0,o.jsx)(n.p,{children:"Configure the script to match your environment."}),"\n",(0,o.jsx)(n.admonition,{type:"caution",children:(0,o.jsx)(n.p,{children:'If you are using IPv4 leave CNODE_HOSTNAME the way it is. The service will pick up your public IP address on it\'s own. I repeat only change the port to 3001. For DNS change only the first instance. Do not edit "CHANGE ME" further down in the file.'})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"cd ${NODE_HOME}/scripts/\n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"nano topologyUpdater.sh\n"})}),"\n",(0,o.jsx)(n.p,{children:"Run the updater once to confirm it is working."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"./topologyUpdater.sh\n"})}),"\n",(0,o.jsx)(n.p,{children:"Should look similar to this."}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.code,{children:'{ "resultcode": "201", "datetime":"2021-05-20 10:13:40", "clientIp": "1.2.3.4", "iptype": 4, "msg": "nice to meet you" }'})}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"3-enable-cron-job",children:"3. Enable cron job"}),"\n",(0,o.jsx)(n.p,{children:"Enable the cron job by removing the # character from crontab."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"crontab -e\n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",metastring:'title="crontab"',children:"33 * * * * /home/ada/pi-pool/scripts/topologyUpdater.sh\n"})}),"\n",(0,o.jsx)(n.p,{children:"Save and exit."}),"\n",(0,o.jsx)(n.h2,{id:"4-wait-for-service-on-boarding-4-hours",children:"4. Wait for service on boarding (4 hours)."}),"\n",(0,o.jsxs)(n.p,{children:["After four hours of on boarding your relay(s) will start to be available to other peers on the network. ",(0,o.jsx)(n.strong,{children:"topologyUpdater.sh"})," will create a list in ${NODE_HOME}/logs."]}),"\n",(0,o.jsx)(n.h2,{id:"5-prune-list-of-best-8-peers",children:"5. Prune list of best (8) peers."}),"\n",(0,o.jsxs)(n.p,{children:["Open your topolgy file and use ",(0,o.jsx)(n.strong,{children:"ctrl+k"})," to cut the entire line of any peer over 5,000 miles away."]}),"\n",(0,o.jsx)(n.admonition,{type:"caution",children:(0,o.jsx)(n.p,{children:"Remember to remove the last entries comma in your list or cardano-node will fail to start."})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"nano ${NODE_HOME}/files/${NODE_CONFIG}-topology.json\n"})}),"\n",(0,o.jsx)(n.h2,{id:"6-enable-blockfetch-tracing",children:"6. Enable blockfetch tracing"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:'sed -i ${NODE_FILES}/mainnet-config.json \\\n    -e "s/TraceBlockFetchDecisions\\": false/TraceBlockFetchDecisions\\": true/g"\n'})}),"\n",(0,o.jsx)(n.p,{children:"Reboot your new relay and let it sync back to the tip of the chain."}),"\n",(0,o.jsx)(n.p,{children:"Use gLiveView.sh to view peer info."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"cd /home/ada/pi-pool/scripts\n./gLiveView.sh\n"})}),"\n",(0,o.jsx)(n.p,{children:"Many operators block icmp syn packets(ping) because of a security flaw that was patched a decade ago. So expect to see --- for RTT because we are not receiving a response from that server."}),"\n",(0,o.jsx)(n.p,{children:"More incoming connections is generally a good thing, it increases the odds that you will get network data sooner. Though you may want to put a limit on how many connect. The only way to stop incoming connections would be to block the IPv4 address with ufw."}),"\n",(0,o.jsx)(n.h2,{id:"7-edit-the-alias-name-for-prometheus",children:"7. Edit the alias name for Prometheus"}),"\n",(0,o.jsx)(n.p,{children:"Last thing we can do is change the alias name Prometheus is serving to Grafana. You will have to go into Grafana and edit the panels alias accordingly as well."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"sudo nano /etc/prometheus/prometheus.yml\n"})}),"\n",(0,o.jsxs)(n.admonition,{type:"caution",children:[(0,o.jsx)(n.p,{children:"In an upcoming guide I will show how to have Prometheus running on a separate Pi scraping data from the pool instead of having Prometheus using system resources on those machines."}),(0,o.jsx)(n.p,{children:"For now you can change the alias name Prometheus is serving to Grafana:"}),(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"alias: 'N1'"}),"\n"]}),(0,o.jsx)(n.p,{children:"to"}),(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"alias: 'R1'"}),"\n"]})]}),"\n",(0,o.jsxs)(n.admonition,{type:"danger",children:[(0,o.jsx)(n.mdxAdmonitionTitle,{}),(0,o.jsx)(n.p,{children:"This is a yaml file and indentation has to be correct."})]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",metastring:'title="/etc/prometheus/prometheus.yml"',children:"global:\n  scrape_interval:     15s # By default, scrape targets every 15 seconds.\n\n  # Attach these labels to any time series or alerts when communicating with\n  # external systems (federation, remote storage, Alertmanager).\n  external_labels:\n    monitor: 'codelab-monitor'\n\n# A scrape configuration containing exactly one endpoint to scrape:\n# Here it's Prometheus itself.\nscrape_configs:\n  # The job name is added as a label job=<job_name> to any timeseries scraped from this config.\n  - job_name: 'Prometheus' # To scrape data from the cardano node\n    scrape_interval: 5s\n    static_configs:\n#      - targets: ['<CORE PRIVATE IP>:12798']\n#        labels:\n#          alias: 'C1'\n#          type:  'cardano-node'\n#      - targets: ['<RELAY PRIVATE IP>:12798']\n#        labels:\n#          alias: 'R1'\n#          type:  'cardano-node'\n      - targets: ['localhost:12798']\n        labels:\n          alias: 'R1'\n          type:  'cardano-node'\n\n#      - targets: ['<CORE PRIVATE IP>:9100']\n#        labels:\n#          alias: 'C1'\n#          type:  'node'\n#      - targets: ['<RELAY PRIVATE IP>:9100']\n#        labels:\n#          alias: 'R1'\n#          type:  'node'\n      - targets: ['localhost:9100']\n        labels:\n          alias: 'R1'\n          type:  'node'\n"})}),"\n",(0,o.jsx)(n.p,{children:"Update, save and exit."}),"\n",(0,o.jsx)(n.h2,{id:"8-reboot",children:"8. Reboot"}),"\n",(0,o.jsxs)(n.p,{children:["Reboot the server and give it a while to sync back up. That is just about it. Please feel free to join our Telegram channel for support. ",(0,o.jsx)(n.a,{href:"https://t.me/armada_alli",children:"https://t.me/armada_alli"})]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},8453:(e,n,a)=>{a.d(n,{R:()=>r,x:()=>s});var o=a(6540);const t={},i=o.createContext(t);function r(e){const n=o.useContext(i);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),o.createElement(i.Provider,{value:n},e.children)}}}]);