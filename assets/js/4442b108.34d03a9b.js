"use strict";(self.webpackChunkarmada_alliance_docusaurus=self.webpackChunkarmada_alliance_docusaurus||[]).push([[522],{2110:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>u,contentTitle:()=>o,default:()=>p,frontMatter:()=>l,metadata:()=>c,toc:()=>d});var t=r(4848),a=r(8453),s=r(1470),i=r(9365);const l={},o="Wireguard Guide",c={id:"stake-pool-guides/wireguard-guide",title:"Wireguard Guide",description:"From the WireGuard project homepage:",source:"@site/docs/stake-pool-guides/wireguard-guide.md",sourceDirName:"stake-pool-guides",slug:"/stake-pool-guides/wireguard-guide",permalink:"/docs/stake-pool-guides/wireguard-guide",draft:!1,unlisted:!1,editUrl:"https://github.com/armada-alliance/docs/edit/master/docs/stake-pool-guides/wireguard-guide.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Basic Stake Pool Networking",permalink:"/docs/stake-pool-guides/basic-stake-pool-networking"},next:{title:"Enable P2P Networking",permalink:"/docs/stake-pool-guides/p2p-networking"}},u={},d=[{value:"Install Wireguard",id:"install-wireguard",level:3},{value:"Configure",id:"configure",level:4},{value:"wg-quick",id:"wg-quick",level:4},{value:"Topology",id:"topology",level:4},{value:"Prometheus",id:"prometheus",level:4},{value:"UFW",id:"ufw",level:3}];function h(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h3:"h3",h4:"h4",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"wireguard-guide",children:"Wireguard Guide"}),"\n",(0,t.jsxs)(n.p,{children:["From the ",(0,t.jsx)(n.a,{href:"https://www.wireguard.com",children:"WireGuard"})," project homepage:"]}),"\n",(0,t.jsx)(n.p,{children:"WireGuard is an extremely simple yet fast and modern VPN that utilizes state-of-the-art cryptography. It aims to be faster, simpler, leaner, and more useful than IPsec, while avoiding the massive headache. It intends to be considerably more performant than OpenVPN. WireGuard is designed as a general purpose VPN for running on embedded interfaces and super computers alike, fit for many different circumstances. Initially released for the Linux kernel, it is now cross-platform (Windows, macOS, BSD, iOS, Android) and widely deployable."}),"\n",(0,t.jsxs)(n.admonition,{type:"success",children:[(0,t.jsx)(n.p,{children:"This guide will create a VPN from a core node behind a firewall to a relay node with Wireguard listening on the default port 51820. We will then control traffic between the connected interfaces with UFW."}),(0,t.jsx)(n.p,{children:"Feel free to use a different port!"})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"https://github.com/pirate/wireguard-docs",children:"WireGuard Documentation"})}),"\n",(0,t.jsx)(n.h3,{id:"install-wireguard",children:"Install Wireguard"}),"\n",(0,t.jsx)(n.p,{children:"Do this on both machines."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"sudo apt install wireguard\n"})}),"\n",(0,t.jsx)(n.p,{children:"Become root."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"sudo su\n"})}),"\n",(0,t.jsx)(n.p,{children:"Enter the Wireguard folder and set permissions for any new files created to root only."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"cd /etc/wireguard\numask 077\n"})}),"\n",(0,t.jsx)(n.h4,{id:"configure",children:"Configure"}),"\n",(0,t.jsx)(n.p,{children:"Generate key pairs on each machine."}),"\n",(0,t.jsxs)(s.A,{children:[(0,t.jsx)(i.A,{value:"C1",label:"C1",default:!0,children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"wg genkey | tee C1-privkey | wg pubkey > C1-pubkey\n"})})}),(0,t.jsx)(i.A,{value:"R1",label:"R1",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"wg genkey | tee R1-privkey | wg pubkey > R1-pubkey\n"})})})]}),"\n",(0,t.jsx)(n.p,{children:"Create a Wireguard configuration file on both machines."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"nano /etc/wireguard/wg0.conf\n"})}),"\n",(0,t.jsx)(n.p,{children:"Use cat to print out the key values. Public keys are then used in the other machines conf file."}),"\n",(0,t.jsxs)(s.A,{children:[(0,t.jsx)(i.A,{value:"C1",label:"C1",default:!0,children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"cat C1-privkey\ncat C1-pubkey\n"})})}),(0,t.jsx)(i.A,{value:"R1",label:"R1",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"cat R1-privkey\ncat R1-pubkey\n"})})})]}),"\n",(0,t.jsxs)(s.A,{children:[(0,t.jsx)(i.A,{value:"C1",label:"C1",default:!0,children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:'[Interface]\nAddress = 10.220.0.1/32\nSaveConfig = true\nListenPort = 51820\nPostUp = wg set %i private-key <path to private key>\n##PostUp = resolvectl domain %i "~."; resolvectl dns %i 10.220.0.2; resolvectl dnssec %i yes\n\n[Peer]\nPublicKey = <result of cat R1-pubkey>\nAllowedIPs = 10.220.0.2/32\nEndpoint = <R1 nodes public ip or hostname>:51820\nPersistentKeepalive = 21\n'})})}),(0,t.jsx)(i.A,{value:"R1",label:"R1",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"[Interface]\nAddress = 10.220.0.2/32\nSaveConfig = true\nListenPort = 51820\nPostUp = wg set %i private-key <path to private key>\n\n[Peer]\nPublicKey = <result of cat C1-pubkey>\nAllowedIPs = 10.220.0.1/32\n#Endpoint = endpoint is not needed on the listening side\nPersistentKeepalive = 21\n"})})}),(0,t.jsx)(i.A,{value:"Example",label:"Example",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"[Interface]\nAddress = 10.220.0.1/32\nSaveConfig = true\nListenPort = 51820\nPostUp = wg set %i private-key /etc/wireguard/C1-privkey\n\n[Peer]\nPublicKey = FnXP9t17JXTCf3kyuTBh/z83NeJsE8Ar2HtOCy2VPyw=\nAllowedIPs = 10.220.0.2/32\nEndpoint = r1.armada-alliance.com:51820\nPersistentKeepalive = 21\n"})})})]}),"\n",(0,t.jsx)(n.h4,{id:"wg-quick",children:(0,t.jsx)(n.a,{href:"https://manpages.debian.org/unstable/wireguard-tools/wg-quick.8.en.html",children:"wg-quick"})}),"\n",(0,t.jsx)(n.p,{children:"Use wg-quick to create the interface & manage Wireguard as a Systemd service on both machines"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"wg-quick up wg0\n"})}),"\n",(0,t.jsx)(n.p,{children:"Useful commands."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"sudo wg show # metrics on the interface\nip a # should see a wg0 interface\n"})}),"\n",(0,t.jsx)(n.p,{children:"Once both interfaces are up you can try and ping each other."}),"\n",(0,t.jsxs)(s.A,{children:[(0,t.jsx)(i.A,{value:"C1",label:"C1",default:!0,children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"ping 10.220.0.2\n"})})}),(0,t.jsx)(i.A,{value:"R1",label:"R1",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"ping 10.220.0.1\n"})})})]}),"\n",(0,t.jsx)(n.p,{children:"If they are connected bring them down and back up with Systemd"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"wg-quick down wg0\nsudo systemctl start wg-quick@wg0\n"})}),"\n",(0,t.jsx)(n.p,{children:"Enable the Wireguard service on both machines to automatically start on boot."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"sudo systemctl enable wg-quick@wg0\nsudo systemctl status wg-quick@wg0\n"})}),"\n",(0,t.jsx)(n.admonition,{type:"danger",children:(0,t.jsx)(n.p,{children:"SaveConfig saves the loaded wg0.conf file in runtime and overwrites the file when it stops. Therefore you must stop the wg-quick@wg0 service before editing the configuration file or your changes will be overwritten when you try to restart the service or reboot the server."})}),"\n",(0,t.jsx)(n.p,{children:"Like so"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"# become root\nsudo su\n# stop the service\nsystemctl stop wg-quick@wg0\n# edit the configuration file\nnano /etc/wireguard/wg0.conf\n# start the service\nsystemctl start wg-quick@wg0\n"})}),"\n",(0,t.jsx)(n.p,{children:"There is a shortcut you can use instead of the steps above if you are adding or updating peers. The following will reload the config file without affecting peer connections:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=">_ Terminal"',children:"sudo wg syncconf wg0 <(wg-quick strip wg0)\n"})}),"\n",(0,t.jsx)(n.h4,{id:"topology",children:"Topology"}),"\n",(0,t.jsx)(n.p,{children:"You can now update your C1 & R1 topology files so they point 10.220.0.2 & 10.220.0.1 respectively through the Wireguard VPN."}),"\n",(0,t.jsx)(n.h4,{id:"prometheus",children:"Prometheus"}),"\n",(0,t.jsx)(n.p,{children:"Likewise update IPv4 address' in /etc/prometheus/prometheus.yml to use the VPN."}),"\n",(0,t.jsx)(n.h3,{id:"ufw",children:"UFW"}),"\n",(0,t.jsx)(n.p,{children:"Control traffic through the VPN. The following allows for Prometheus/Grafana on C1 to scrape metrics from node-exporter on R1."}),"\n",(0,t.jsxs)(s.A,{children:[(0,t.jsx)(i.A,{value:"C1",label:"C1",default:!0,children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# allow ssh access on lan behind router\nsudo ufw allow 22\n# deny ssh access from R1 to C1\nsudo ufw deny in on wg0 to any port 22 proto tcp\n# cardano-node port\nsudo ufw allow 3000\n"})})}),(0,t.jsx)(i.A,{value:"R1",label:"R1",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# allow ssh access\nsudo ufw allow 22\n# wireguard service\nsudo ufw allow 51820/udp\n# cardano-node port\nsudo ufw allow 3001\n# allow prometheus on C1 to scrape exporter metrics on R1\nsudo ufw allow in on wg0 to any port 12798 proto tcp\nsudo ufw allow in on wg0 to any port 9090 proto tcp\n"})})})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Bring up ufw"})}),"\n",(0,t.jsx)(n.p,{children:"When you're sure you are not going to lock yourself out and that all the ports for your pool that need to be open are open you can bring up the firewall. Don't forget 80 & 443 if you have nginx proxying Grafana."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo ufw enable\n# view rules\nsudo ufw status numbered\n"})}),"\n",(0,t.jsx)(n.p,{children:"Notes & links/To Do"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'PostUp = resolvectl domain %i "~."; resolvectl dns %i 192.0.2.1; resolvectl dnssec %i yes\n'})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"PostUp = wg set %i private-key /etc/wireguard/wg0.key <(cat /some/path/%i/privkey)\n"})})]})}function p(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}},9365:(e,n,r)=>{r.d(n,{A:()=>i});r(6540);var t=r(8215);const a={tabItem:"tabItem_Ymn6"};var s=r(4848);function i(e){let{children:n,hidden:r,className:i}=e;return(0,s.jsx)("div",{role:"tabpanel",className:(0,t.A)(a.tabItem,i),hidden:r,children:n})}},1470:(e,n,r)=>{r.d(n,{A:()=>y});var t=r(6540),a=r(8215),s=r(3104),i=r(6347),l=r(205),o=r(7485),c=r(1682),u=r(679);function d(e){return t.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,t.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function h(e){const{values:n,children:r}=e;return(0,t.useMemo)((()=>{const e=n??function(e){return d(e).map((e=>{let{props:{value:n,label:r,attributes:t,default:a}}=e;return{value:n,label:r,attributes:t,default:a}}))}(r);return function(e){const n=(0,c.X)(e,((e,n)=>e.value===n.value));if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[n,r])}function p(e){let{value:n,tabValues:r}=e;return r.some((e=>e.value===n))}function g(e){let{queryString:n=!1,groupId:r}=e;const a=(0,i.W6)(),s=function(e){let{queryString:n=!1,groupId:r}=e;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!r)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return r??null}({queryString:n,groupId:r});return[(0,o.aZ)(s),(0,t.useCallback)((e=>{if(!s)return;const n=new URLSearchParams(a.location.search);n.set(s,e),a.replace({...a.location,search:n.toString()})}),[s,a])]}function m(e){const{defaultValue:n,queryString:r=!1,groupId:a}=e,s=h(e),[i,o]=(0,t.useState)((()=>function(e){let{defaultValue:n,tabValues:r}=e;if(0===r.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!p({value:n,tabValues:r}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${n}" but none of its children has the corresponding value. Available values are: ${r.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return n}const t=r.find((e=>e.default))??r[0];if(!t)throw new Error("Unexpected error: 0 tabValues");return t.value}({defaultValue:n,tabValues:s}))),[c,d]=g({queryString:r,groupId:a}),[m,f]=function(e){let{groupId:n}=e;const r=function(e){return e?`docusaurus.tab.${e}`:null}(n),[a,s]=(0,u.Dv)(r);return[a,(0,t.useCallback)((e=>{r&&s.set(e)}),[r,s])]}({groupId:a}),w=(()=>{const e=c??m;return p({value:e,tabValues:s})?e:null})();(0,l.A)((()=>{w&&o(w)}),[w]);return{selectedValue:i,selectValue:(0,t.useCallback)((e=>{if(!p({value:e,tabValues:s}))throw new Error(`Can't select invalid tab value=${e}`);o(e),d(e),f(e)}),[d,f,s]),tabValues:s}}var f=r(2303);const w={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var b=r(4848);function x(e){let{className:n,block:r,selectedValue:t,selectValue:i,tabValues:l}=e;const o=[],{blockElementScrollPositionUntilNextRender:c}=(0,s.a_)(),u=e=>{const n=e.currentTarget,r=o.indexOf(n),a=l[r].value;a!==t&&(c(n),i(a))},d=e=>{let n=null;switch(e.key){case"Enter":u(e);break;case"ArrowRight":{const r=o.indexOf(e.currentTarget)+1;n=o[r]??o[0];break}case"ArrowLeft":{const r=o.indexOf(e.currentTarget)-1;n=o[r]??o[o.length-1];break}}n?.focus()};return(0,b.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,a.A)("tabs",{"tabs--block":r},n),children:l.map((e=>{let{value:n,label:r,attributes:s}=e;return(0,b.jsx)("li",{role:"tab",tabIndex:t===n?0:-1,"aria-selected":t===n,ref:e=>o.push(e),onKeyDown:d,onClick:u,...s,className:(0,a.A)("tabs__item",w.tabItem,s?.className,{"tabs__item--active":t===n}),children:r??n},n)}))})}function j(e){let{lazy:n,children:r,selectedValue:a}=e;const s=(Array.isArray(r)?r:[r]).filter(Boolean);if(n){const e=s.find((e=>e.props.value===a));return e?(0,t.cloneElement)(e,{className:"margin-top--md"}):null}return(0,b.jsx)("div",{className:"margin-top--md",children:s.map(((e,n)=>(0,t.cloneElement)(e,{key:n,hidden:e.props.value!==a})))})}function v(e){const n=m(e);return(0,b.jsxs)("div",{className:(0,a.A)("tabs-container",w.tabList),children:[(0,b.jsx)(x,{...n,...e}),(0,b.jsx)(j,{...n,...e})]})}function y(e){const n=(0,f.A)();return(0,b.jsx)(v,{...e,children:d(e.children)},String(n))}},8453:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>l});var t=r(6540);const a={},s=t.createContext(a);function i(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);